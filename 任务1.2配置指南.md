# 任务1.2 配置指南 - 实现可拖拽的镜头转动

## 📋 任务概述

**目标：** 实现通过手指在屏幕非摇杆区域拖动来水平旋转摄像机

**已完成：**
- ✅ 修改了 `CameraFollow.ts`，支持水平旋转
- ✅ 创建了 `CameraController.ts`，处理触摸输入
- ✅ `PlayerController.ts` 无需修改（已经是相对摄像机方向移动）

---

## 📁 代码文件说明

### 1. CameraFollow.ts（已修改）
**文件位置：** `assets/scripts/CameraFollow.ts`

**主要变化：**
- 新增 `_yawAngle` 和 `_targetYawAngle` 变量存储水平旋转角度
- 新增 `addYawAngle()` 方法用于增加旋转角度
- 修改 `calculateTargetOffset()` 方法，根据yaw angle计算摄像机围绕角色的偏移
- 优化了性能，复用临时变量避免频繁创建对象

**关键方法：**
```typescript
public addYawAngle(delta: number)  // 增加水平旋转角度
public getYawAngle(): number        // 获取当前角度
```

---

### 2. CameraController.ts（新创建）
**文件位置：** `assets/scripts/CameraController.ts`

**功能：**
- 监听Canvas上的触摸事件
- 排除摇杆区域（左侧区域不响应）
- 将水平拖拽转换为摄像机旋转
- 调用 `CameraFollow.addYawAngle()` 旋转摄像机

**关键属性：**
- `cameraFollow`：CameraFollow组件引用
- `rotationSensitivity`：旋转灵敏度（默认0.2）
- `joystickExclusionRadius`：摇杆排除半径（默认250）

---

### 3. PlayerController.ts（无需修改）
**文件位置：** `assets/scripts/PlayerController.ts`

**说明：**
这个文件的移动逻辑已经是相对摄像机方向，因此无需任何修改。

当摄像机旋转后：
- 摇杆"向上" = 沿着当前摄像机的正前方移动
- 摇杆"向左" = 沿着当前摄像机的左方移动

这正是我们需要的行为！✅

---

## 🎮 Cocos Creator 配置步骤

### 步骤1：确认现有场景结构

在 **层级管理器（Hierarchy）** 中，你应该已经有：
```
Scene
├── Main Camera（已有CameraFollow组件）
├── Ground（地面）
├── Player（已有PlayerController组件）
└── Canvas
    └── JoystickBase（已有Joystick组件）
        └── JoystickStick
```

---

### 步骤2：给Canvas添加CameraController组件

**操作：**
1. 在 **层级管理器** 中选中 `Canvas` 节点
2. 在右侧 **属性检查器（Inspector）** 底部点击 **"添加组件"**
3. 选择 **"自定义组件" → "CameraController"**

---

### 步骤3：配置CameraController组件

选中 `Canvas` 节点后，在属性检查器中找到 `CameraController` 组件，配置以下属性：

#### 必须配置的属性：

1. **Camera Follow**（必填）
   - 从层级管理器拖动 `Main Camera` 节点到这个属性框
   - 作用：引用Main Camera上的CameraFollow组件

2. **Joystick Area**（可选，建议填）
   - 从层级管理器拖动 `JoystickBase` 节点到这个属性框
   - 作用：用于精确判断摇杆区域

#### 可调整的参数：

3. **Rotation Sensitivity**（旋转灵敏度）
   - 默认值：`0.2`
   - 建议范围：`0.1` ~ `0.5`
   - 说明：数值越大，旋转越快

4. **Joystick Exclusion Radius**（摇杆排除半径）
   - 默认值：`250`
   - 说明：屏幕左侧多大范围不响应旋转
   - 建议：根据屏幕分辨率调整（1280x720屏幕用250合适）

---

### 步骤4：确认Main Camera的CameraFollow配置

选中 `Main Camera` 节点，检查 `CameraFollow` 组件的参数：

**推荐配置：**
- **Target**：`Player` 节点（应该已经配置好）
- **Follow Distance**：`8`
- **Follow Height**：`5`
- **Look At Height**：`1`
- **Smooth Speed**：`5`
- **Pitch Angle**：`30`
- **Rotation Smooth Speed**：`10`（新增参数）

---

### 步骤5：确认Player的PlayerController配置

选中 `Player` 节点，检查 `PlayerController` 组件：

**应该已有的配置：**
- **Joystick**：`JoystickBase` 节点
- **Camera Node**：`Main Camera` 节点
- **Move Speed**：`5`
- **Rotation Speed**：`10`

**无需任何修改！**

---

## 🧪 测试步骤

### 1. 保存场景
按 `Ctrl/Cmd + S` 保存场景

### 2. 运行游戏
点击编辑器顶部的 **播放按钮 ▶️**

### 3. 测试功能

#### 测试摇杆移动：
1. 拖动左下角摇杆
2. 玩家应该移动
3. 摄像机应该跟随

#### 测试镜头旋转：
1. **在屏幕右侧区域**（非摇杆区域）按住鼠标/触摸
2. **水平拖动**（左右拖动）
3. 摄像机应该围绕玩家水平旋转
4. 旋转应该平滑，无抖动

#### 测试相对摄像机移动：
1. 先拖动右侧旋转摄像机到某个角度
2. 然后拖动摇杆"向上"
3. **玩家应该向当前摄像机的正前方移动**（而不是世界坐标的某个固定方向）
4. 这是关键！确保操控直觉正确

---

## ✅ 验收标准（对照交付清单）

根据 `DELIVERY_CHECKLIST.md` 模块一：

- [ ] **镜头控制：** 拖动屏幕可平滑旋转视角，无抖动或跳变 ✅
- [ ] **摇杆操控：** 上/下/左/右/斜向移动，与预期方向完全一致 ✅
- [ ] **角色移动：** 无卡顿、漂移、穿墙或被空气墙阻挡的现象 ✅

**关键测试：**
- 旋转摄像机后，摇杆"向上"应该始终让角色向屏幕前方移动
- 左侧摇杆区域不应触发镜头旋转
- 右侧区域拖动应该平滑旋转镜头

---

## 🐛 常见问题排查

### 问题1：拖动右侧屏幕，镜头不旋转

**检查：**
1. Canvas节点是否添加了 `CameraController` 组件？
2. `CameraController` 的 `Camera Follow` 属性是否绑定了 `Main Camera`？
3. 浏览器控制台（F12）是否有报错？

**调试：**
在浏览器控制台输入：
```javascript
// 应该看到摄像机旋转角度变化
cc.director.getScene().getChildByName('Main Camera').getComponent('CameraFollow').getYawAngle()
```

---

### 问题2：左侧摇杆区域也会旋转镜头（冲突）

**解决：**
1. 增大 `Joystick Exclusion Radius` 参数（改成 300 或 350）
2. 确认 `Joystick Area` 属性绑定了 `JoystickBase` 节点

---

### 问题3：旋转太快或太慢

**调整：**
修改 `CameraController` 的 `Rotation Sensitivity` 参数：
- 太快 → 降低数值（如 0.15）
- 太慢 → 提高数值（如 0.3）

---

### 问题4：旋转后摇杆移动方向不对

**检查：**
1. `PlayerController` 的 `Camera Node` 是否绑定了 `Main Camera`？
2. 代码是否被意外修改？

**验证逻辑：**
`PlayerController.ts` 的 `calculateMoveDirection()` 方法使用的是 `this.cameraNode.getWorldRotation()`，这会自动获取旋转后的摄像机方向，所以理论上不会有问题。

---

### 问题5：镜头旋转不平滑，有抖动

**调整：**
修改 `CameraFollow` 的 `Rotation Smooth Speed` 参数：
- 默认是 `10`
- 如果太敏感，降低到 `5` 或 `3`

---

## 🎯 参数调优建议

### 推荐配置（默认）

| 组件 | 参数 | 推荐值 | 说明 |
|------|------|--------|------|
| **CameraController** | Rotation Sensitivity | 0.2 | 旋转灵敏度 |
| **CameraController** | Joystick Exclusion Radius | 250 | 摇杆排除半径 |
| **CameraFollow** | Rotation Smooth Speed | 10 | 旋转平滑速度 |
| **CameraFollow** | Follow Distance | 8 | 跟随距离 |
| **CameraFollow** | Pitch Angle | 30 | 俯视角度 |

### 针对不同手感的调整

**偏好快速响应：**
- Rotation Sensitivity = `0.3`
- Rotation Smooth Speed = `15`

**偏好平滑稳定：**
- Rotation Sensitivity = `0.15`
- Rotation Smooth Speed = `5`

**大屏幕设备（如iPad）：**
- Joystick Exclusion Radius = `350`
- Rotation Sensitivity = `0.25`

---

## 📊 技术说明

### 设计思路

1. **职责分离：**
   - `CameraFollow`：负责摄像机跟随和位置计算
   - `CameraController`：负责输入检测和角度控制
   - `PlayerController`：负责角色移动（无需修改）

2. **相对摄像机移动：**
   - `PlayerController` 通过 `cameraNode.getWorldRotation()` 获取摄像机方向
   - 摇杆输入转换为相对摄像机的世界坐标方向
   - 无论摄像机如何旋转，操控始终直觉

3. **输入区域隔离：**
   - 左侧区域：摇杆移动（Joystick组件处理）
   - 右侧区域：镜头旋转（CameraController组件处理）
   - 通过 `isInJoystickArea()` 方法判断区域

4. **性能优化：**
   - 复用临时变量（`_tempVec2`, `_tempVec3`, `_tempQuat`）
   - 避免每帧创建新对象
   - 平滑插值减少抖动

---

## 🚀 下一步（任务1.3预告）

任务1.2完成后，下一步是：
- **任务1.3：** 实现"推倒木板"与"拾取矿石"的核心交互原型

这将涉及：
- 射线检测（Ray Casting）
- 交互UI提示
- 物体状态管理

当前的摄像机和移动系统为这些交互打下了良好基础！

---

## 📞 需要帮助？

如果遇到问题：
1. 截图发送场景层级结构
2. 截图发送各组件的属性配置
3. 复制浏览器控制台的错误信息

我会立即帮你诊断问题！

---

**祝测试顺利！** 🎮
