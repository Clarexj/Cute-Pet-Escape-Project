# 任务3.1：集成角色模型与动画 - 代码交付清单

## 📋 任务概述
- **任务名称**：集成角色模型与动画
- **开发阶段**：第三阶段
- **完成日期**：2025-10-02
- **版本号**：V3.1

---

## 📦 新增文件清单

### 1. CharacterAnimationController.ts
**文件路径**：`CocosProject/assets/scripts/CharacterAnimationController.ts`
**文件大小**：约227行
**功能说明**：
- 角色动画状态机控制器
- 支持逃生者和追捕者两种角色类型
- 管理idle、run、attack三种动画状态
- 提供平滑的cross-fade过渡动画
- 攻击动画播放期间自动阻止其他动画切换

**核心接口**：
```typescript
// 动画状态枚举
export enum AnimationState {
    IDLE = 'idle',
    RUN = 'run',
    ATTACK = 'attack'
}

// 角色类型枚举
export enum CharacterType {
    SURVIVOR = 'survivor',
    HUNTER = 'hunter'
}

// 核心方法
public playIdle(): void
public playRun(): void
public playAttack(): void  // 仅追捕者
public updateMovementAnimation(isMoving: boolean): void
public getCurrentState(): AnimationState
public isAttacking(): boolean
```

**Editor配置属性**：
| 属性名 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| animationComponent | AnimationComponent | null | 动画组件引用（必需） |
| idleClip | AnimationClip | null | idle动画剪辑（必需） |
| runClip | AnimationClip | null | run动画剪辑（必需） |
| attackClip | AnimationClip | null | attack动画剪辑（追捕者必需） |
| characterType | CharacterType | SURVIVOR | 角色类型 |
| crossFadeDuration | number | 0.2 | 动画过渡时长（秒） |
| attackAnimationDuration | number | 1.0 | 攻击动画时长（秒） |
| autoFindAnimation | boolean | true | 自动查找动画组件 |

---

## 🔧 修改文件清单

### 2. PlayerController.ts (V1.3 → V1.4)
**文件路径**：`CocosProject/assets/scripts/PlayerController.ts`
**修改内容**：集成动画控制

**新增导入**：
```typescript
import { CharacterAnimationController } from './CharacterAnimationController';
```

**新增属性**：
```typescript
@property(CharacterAnimationController)
public animationController: CharacterAnimationController | null = null;
```

**修改的方法**：
1. `start()` - 添加动画控制器自动检测
2. `update()` - 添加动画状态更新调用

**新增方法**：
```typescript
private updateAnimation(): void
```

**修改行数统计**：
- 第9行：新增import语句
- 第32-33行：新增animationController属性
- 第82-88行：start()中添加自动检测代码
- 第131-132行：update()中添加动画更新调用
- 第136-144行：新增updateAnimation()方法

**总计**：+13行代码

---

### 3. HunterController.ts (V1.0 → V1.1)
**文件路径**：`CocosProject/assets/scripts/HunterController.ts`
**修改内容**：集成动画控制及攻击动画

**新增导入**：
```typescript
import { CharacterAnimationController } from './CharacterAnimationController';
```

**新增属性**：
```typescript
@property(CharacterAnimationController)
public animationController: CharacterAnimationController | null = null;
```

**修改的方法**：
1. `start()` - 添加动画控制器自动检测
2. `update()` - 添加动画状态更新调用
3. `triggerAttack()` - 添加攻击动画播放

**新增方法**：
```typescript
private updateAnimation(): void
```

**修改行数统计**：
- 第10行：新增import语句
- 第36-37行：新增animationController属性
- 第89-95行：start()中添加自动检测代码
- 第143-144行：update()中添加动画更新调用
- 第148-156行：新增updateAnimation()方法
- 第263-266行：triggerAttack()中添加攻击动画播放

**总计**：+17行代码

---

## 📄 配置文档清单

### 4. 任务3.1_Cocos Creator配置步骤.md
**文件路径**：`_docs/任务3.1_Cocos Creator配置步骤.md`
**文件大小**：约800行
**内容结构**：

#### 章节1：FBX模型导入配置
- 导入FBX文件到指定目录
- 配置模型导入选项（网格、骨骼、动画）
- 验证导入结果

#### 章节2：动画剪辑提取
- 自动提取方式（推荐）
- 手动拆分方式
- 动画剪辑命名规范

#### 章节3：场景配置步骤
**3.1 逃生者角色配置**（9个步骤）
- 创建Model子节点
- 拖入FBX模型
- 添加Animation组件
- 添加CharacterAnimationController组件
- 绑定动画剪辑
- 关联到PlayerController
- 隐藏原始Capsule

**3.2 追捕者角色配置**（10个步骤）
- 同上逃生者步骤
- 额外配置attack动画剪辑

#### 章节4：动画组件详细配置
- Animation组件参数说明
- CharacterAnimationController参数说明
- 各参数的推荐值和调优建议

#### 章节5：高级选项（可选）
- 使用Animation Graph的优势
- 动画过渡曲线调整
- 根运动(Root Motion)配置

#### 章节6：测试检查清单
- 逃生者测试项（5项）
- 追捕者测试项（6项）
- 性能测试项（2项）

#### 章节7：常见问题排查
- 动画不播放（4种情况）
- 动画切换不平滑（2种解决方案）
- 攻击动画异常（2种情况）
- 模型显示异常（3种情况）
- 性能问题（2种优化建议）
- 其他已知问题（1项）

---

## 🧪 测试验证清单

### ✅ 逃生者动画测试
- [ ] 静止时播放idle动画
- [ ] 推动摇杆后平滑切换到run动画
- [ ] 松开摇杆后平滑切换回idle动画
- [ ] 动画过渡自然无跳变
- [ ] 角色朝向与移动方向一致

### ✅ 追捕者动画测试
- [ ] 静止时播放idle动画
- [ ] 推动摇杆后平滑切换到run动画
- [ ] 松开摇杆后平滑切换回idle动画
- [ ] 点击攻击按钮播放attack动画
- [ ] 攻击动画播放期间不受摇杆影响
- [ ] 攻击动画播放完成后自动返回idle或run状态

### ✅ 性能测试
- [ ] 场景中4个角色同时移动时帧率正常（>30fps）
- [ ] Console无错误或警告信息

---

## 📊 代码统计

| 项目 | 数量 |
|------|------|
| 新增脚本 | 1个 |
| 修改脚本 | 2个 |
| 新增代码行数 | ~227行 |
| 修改代码行数 | ~30行 |
| 新增文档 | 2个 |
| 文档总字数 | ~2000字 |
| 支持的动画状态 | 3种 |
| 支持的角色类型 | 2种 |

---

## 🔗 依赖关系图

```
CharacterAnimationController.ts (新增)
        ↑
        ├── PlayerController.ts (修改)
        │   └── 调用 updateMovementAnimation(isMoving)
        │
        └── HunterController.ts (修改)
            ├── 调用 updateMovementAnimation(isMoving)
            └── 调用 playAttack()
```

---

## 📌 配置要点提醒

### ⚠️ 必需配置项
1. **Animation组件**必须添加到模型节点（而非角色根节点）
2. **CharacterAnimationController**必须添加到模型节点
3. **逃生者**必须绑定idle和run剪辑
4. **追捕者**必须绑定idle、run和attack剪辑
5. **characterType**必须设置正确（SURVIVOR或HUNTER）

### 💡 推荐配置项
- `crossFadeDuration`设置为0.2秒（默认值）
- `attackAnimationDuration`根据实际动画长度调整
- `autoFindAnimation`保持true（自动查找）

### ⚡ 性能优化建议
- 动画剪辑使用压缩格式
- 避免过长的cross-fade时间
- 动画采样率不超过30fps（除非必要）

---

## 📝 版本说明

### V3.1 更新内容
- ✅ 新增角色动画状态机系统
- ✅ 支持idle、run、attack三种动画状态
- ✅ 实现平滑的cross-fade过渡
- ✅ 追捕者攻击动画集成
- ✅ 自动化动画控制（基于移动状态）

### 向后兼容性
- ✅ 完全兼容V1.3版本的PlayerController
- ✅ 完全兼容V1.0版本的HunterController
- ✅ 保留原有Capsule/Cube作为fallback
- ✅ 动画控制器为可选组件（未绑定时不影响游戏逻辑）

---

## 🚀 下一步建议

### 立即可做
1. 按照配置文档在Cocos Creator中设置逃生者和追捕者
2. 测试动画播放和切换效果
3. 根据实际动画长度调整`attackAnimationDuration`参数

### 后续优化
1. 创建动画预制体（Prefab）以便复用
2. 使用Animation Graph替代脚本控制（可选）
3. 添加更多动画状态（如受伤、死亡、救援等）
4. 实现动画事件（Animation Events）触发游戏逻辑

---

## 📧 技术支持

如配置过程中遇到问题，请参考：
1. `任务3.1_Cocos Creator配置步骤.md` 的故障排查章节
2. CharacterAnimationController.ts 中的注释说明
3. Cocos Creator官方文档 - 动画系统

---

**文档生成时间**：2025-10-02
**脚本版本**：V3.1
**引擎要求**：Cocos Creator 3.x
**测试状态**：✅ 代码审查通过，等待实机测试
