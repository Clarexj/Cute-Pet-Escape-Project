# 任务4.1：客户端配置指南（Cocos Creator）

**文档版本**：V4.1
**创建日期**：2025-10-03
**技术方案**：Colyseus + Cocos Creator

---

## 📋 目录

1. [安装Colyseus客户端库](#1-安装colyseus客户端库)
2. [创建网络脚本组件](#2-创建网络脚本组件)
3. [创建大厅场景(LobbyScene)](#3-创建大厅场景lobbyscene)
4. [配置游戏场景(GameScene)](#4-配置游戏场景gamescene)
5. [创建远程玩家预制体](#5-创建远程玩家预制体)
6. [配置本地玩家同步](#6-配置本地玩家同步)
7. [测试网络连接](#7-测试网络连接)

---

## 1. 安装Colyseus客户端库

### 1.1 下载Colyseus.js

**方法1：使用CDN（推荐）**

1. 访问：https://unpkg.com/colyseus.js@0.15.0/dist/colyseus.js
2. 浏览器会显示JavaScript代码
3. 按 `Ctrl+S` (Windows) 或 `Cmd+S` (Mac) 保存文件
4. 保存到项目路径：
   ```
   /Users/clare/Desktop/前哨AI小课/ClareProject/Cute-Pet-Escape-Project/CocosProject/assets/libs/colyseus.js
   ```

**方法2：使用npm（如果你有Node.js）**

```bash
cd /Users/clare/Desktop/前哨AI小课/ClareProject/Cute-Pet-Escape-Project/CocosProject

# 创建libs文件夹
mkdir -p assets/libs

# 下载Colyseus
npm install colyseus.js@0.15.0

# 复制到assets
cp node_modules/colyseus.js/dist/colyseus.js assets/libs/
```

---

### 1.2 在Cocos Creator中导入

1. **打开Cocos Creator**
2. **打开项目**：`Cute-Pet-Escape-Project/CocosProject`
3. **检查Assets面板**：
   - 应该看到 `assets/libs/colyseus.js`
   - 如果没有，点击Assets面板右键 → "重新导入资源"

4. **配置为插件**：
   - 选中 `colyseus.js` 文件
   - 在属性检查器(Properties)中
   - 勾选 **"作为插件导入"** (Import As Plugin)
   - 点击右上角 **"应用"** (Apply)

![Colyseus配置示例](https://docs.cocos.com/creator/manual/zh/scripting/plugin-scripts.html)

---

### 1.3 验证安装

**创建测试脚本**（可选）：

```typescript
// 临时测试文件：assets/scripts/test/NetworkTest.ts
import { _decorator, Component } from 'cc';
const { ccclass } = _decorator;

@ccclass('NetworkTest')
export class NetworkTest extends Component {
    start() {
        // 检查Colyseus是否可用
        if (typeof Colyseus !== 'undefined') {
            console.log('✅ Colyseus库加载成功！');
            console.log('Colyseus版本:', Colyseus.version);
        } else {
            console.error('❌ Colyseus库未找到！');
        }
    }
}
```

**运行测试**：
1. 创建空节点，挂载 `NetworkTest` 组件
2. 运行场景
3. 查看Console输出：应该看到 "✅ Colyseus库加载成功！"

---

## 2. 创建网络脚本组件

所有脚本文件已在 `CocosProject/assets/scripts/` 目录下创建：

### 2.1 文件列表

**网络核心**：
- `network/NetworkManager.ts` - 网络管理器（单例）
- `network/PlayerSyncController.ts` - 本地玩家同步
- `network/RemotePlayerController.ts` - 远程玩家控制
- `network/RemotePlayerManager.ts` - 远程玩家管理器

**UI界面**：
- `ui/LobbyUI.ts` - 大厅UI
- `ui/RoomUI.ts` - 房间UI

### 2.2 验证脚本导入

1. 在Cocos Creator中打开 **"资源管理器"** (Assets)
2. 展开 `assets/scripts/network/` 和 `assets/scripts/ui/`
3. 检查所有脚本文件是否存在
4. 如果有编译错误，查看 **"控制台"** (Console)

**常见错误修复**：

- **错误1**：`Cannot find module 'colyseus.js'`
  - **解决**：检查步骤1.2，确保colyseus.js已导入并标记为插件

- **错误2**：`Property 'Colyseus' does not exist on type 'Window'`
  - **解决**：在 `NetworkManager.ts` 顶部添加：
    ```typescript
    declare const Colyseus: any;
    ```

---

## 3. 创建大厅场景(LobbyScene)

### 3.1 创建场景文件

1. 在Assets面板，右键 → **"新建场景"** (New Scene)
2. 命名为 `LobbyScene`
3. 保存到：`assets/scenes/LobbyScene.scene`

---

### 3.2 创建UI结构

**场景层级结构**：

```
LobbyScene
├── Canvas (已有)
│   ├── Camera (已有)
│   └── LobbyPanel (新建 Node)
│       ├── TitleLabel (新建 Label)
│       ├── PlayerNamePanel (新建 Node)
│       │   ├── NameLabel (新建 Label)
│       │   ├── NameInput (新建 EditBox)
│       │   └── RandomButton (新建 Button)
│       ├── CreateRoomButton (新建 Button)
│       ├── JoinRoomPanel (新建 Node)
│       │   ├── RoomIdLabel (新建 Label)
│       │   ├── RoomIdInput (新建 EditBox)
│       │   └── JoinButton (新建 Button)
│       ├── StatusLabel (新建 Label)
│       └── LoadingPanel (新建 Node)
│           └── LoadingLabel (新建 Label)
└── NetworkManager (新建 Node)
```

---

### 3.3 详细配置步骤

#### 步骤1：创建NetworkManager节点

1. 右键Canvas → **"创建空节点"** → 命名 `NetworkManager`
2. 选中 `NetworkManager` 节点
3. 在属性检查器，点击 **"添加组件"** → **"自定义组件"** → 选择 `NetworkManager`
4. 配置NetworkManager组件：
   - **Server Url**: `ws://localhost:2567` (本地测试)
   - **Auto Connect**: ✅ 勾选
   - **Enable Debug Log**: ✅ 勾选

#### 步骤2：创建LobbyPanel

1. 右键Canvas → **"创建空节点"** → 命名 `LobbyPanel`
2. 设置LobbyPanel的Widget组件（让UI适配屏幕）：
   - 添加组件 → UI → **Widget**
   - Left: 0, Right: 0, Top: 0, Bottom: 0
   - 勾选 **"对齐目标"** (Align Target): Canvas

#### 步骤3：创建标题(TitleLabel)

1. 右键LobbyPanel → **"创建UI节点"** → **Label**
2. 命名为 `TitleLabel`
3. 配置Label组件：
   - **String**: "可爱宠物大逃杀 - 联机大厅"
   - **Font Size**: 48
   - **Color**: 白色
4. 配置Transform：
   - Position: (0, 300, 0)

#### 步骤4：创建玩家名称输入区(PlayerNamePanel)

1. 右键LobbyPanel → **"创建空节点"** → 命名 `PlayerNamePanel`
2. Position: (0, 150, 0)

**子元素A：NameLabel**
- 创建Label节点，命名 `NameLabel`
- String: "玩家名称："
- Position: (-150, 0, 0)

**子元素B：NameInput**
- 创建EditBox节点，命名 `NameInput`
- Position: (0, 0, 0)
- Placeholder: "输入你的名字"
- Max Length: 20
- Background Image: 需要添加一个Sprite背景（可用白色方块）

**子元素C：RandomButton**
- 创建Button节点，命名 `RandomButton`
- Position: (150, 0, 0)
- Label文字: "随机"
- Size: (120, 50)

#### 步骤5：创建房间按钮

**A. CreateRoomButton**
1. 右键LobbyPanel → **"创建UI节点"** → **Button**
2. 命名 `CreateRoomButton`
3. Position: (0, 50, 0)
4. Size: (300, 60)
5. 子节点Label的String: "创建房间"

**B. JoinRoomPanel**
1. 右键LobbyPanel → **"创建空节点"** → 命名 `JoinRoomPanel`
2. Position: (0, -50, 0)

- **子元素：RoomIdLabel**
  - 创建Label，String: "房间ID："
  - Position: (-150, 0, 0)

- **子元素：RoomIdInput**
  - 创建EditBox
  - Position: (-30, 0, 0)
  - Placeholder: "输入房间ID"
  - Max Length: 30

- **子元素：JoinButton**
  - 创建Button
  - Position: (120, 0, 0)
  - Label文字: "加入"

#### 步骤6：创建状态显示

**StatusLabel**
- 右键LobbyPanel → 创建Label
- 命名 `StatusLabel`
- Position: (0, -150, 0)
- String: ""
- Color: 绿色 (0, 255, 0, 255)

**LoadingPanel**
- 右键LobbyPanel → 创建空节点
- 命名 `LoadingPanel`
- Position: (0, -200, 0)
- 默认隐藏：Active = false

- **子元素：LoadingLabel**
  - 创建Label
  - String: "连接中..."

---

### 3.4 挂载LobbyUI脚本

1. 选中 `LobbyPanel` 节点
2. 添加组件 → 自定义组件 → **LobbyUI**
3. 配置LobbyUI组件（拖拽引用）：

| 属性 | 拖拽目标节点 |
|------|-------------|
| **playerNameInput** | PlayerNamePanel/NameInput |
| **randomNameButton** | PlayerNamePanel/RandomButton |
| **createRoomButton** | CreateRoomButton |
| **roomIdInput** | JoinRoomPanel/RoomIdInput |
| **joinRoomButton** | JoinRoomPanel/JoinButton |
| **statusLabel** | StatusLabel |
| **loadingPanel** | LoadingPanel |

4. 配置其他属性：
   - **autoGeneratePlayerName**: ✅ 勾选
   - **gameSceneName**: "GameScene"

---

### 3.5 测试大厅场景

1. 保存场景 (Ctrl+S / Cmd+S)
2. 点击 **"运行场景"** (播放按钮)
3. 预期效果：
   - ✅ 看到"可爱宠物大逃杀 - 联机大厅"标题
   - ✅ 玩家名称输入框有随机名字
   - ✅ "创建房间"和"加入"按钮可见
   - ✅ Console显示："[NetworkManager] 网络管理器初始化"

**如果点击"创建房间"**：
- 应该看到StatusLabel显示"连接中..."
- 如果服务器未启动，会显示错误信息
- （此时先不测试，等服务器启动后再测）

---

## 4. 配置游戏场景(GameScene)

### 4.1 打开现有游戏场景

1. 在Assets面板，找到 `assets/scenes/GameScene.scene`
2. 双击打开

---

### 4.2 添加房间UI

**创建RoomUIPanel**：

1. 右键Canvas → **"创建空节点"** → 命名 `RoomUIPanel`
2. 添加Widget组件：
   - Top: 10, Left: 10
   - 勾选 **"对齐顶部"** 和 **"对齐左侧"**

**子元素结构**：
```
RoomUIPanel
├── RoomIdLabel (Label)
├── PlayerCountLabel (Label)
├── StatusLabel (Label)
└── LeaveRoomButton (Button) [可选]
```

**配置示例**：

**RoomIdLabel**：
- String: "房间ID: ----"
- Position: (0, 0, 0)
- Anchor: 左上角

**PlayerCountLabel**：
- String: "玩家: 1/5"
- Position: (0, -40, 0)

**StatusLabel**：
- String: "已连接"
- Position: (0, -80, 0)
- Color: 绿色

---

### 4.3 挂载RoomUI脚本

1. 选中 `RoomUIPanel` 节点
2. 添加组件 → 自定义组件 → **RoomUI**
3. 配置RoomUI组件：

| 属性 | 拖拽目标 |
|------|---------|
| **roomIdLabel** | RoomIdLabel |
| **playerCountLabel** | PlayerCountLabel |
| **statusLabel** | StatusLabel |
| **leaveRoomButton** | LeaveRoomButton（如果有） |

4. 配置属性：
   - **showRoomId**: ✅ 勾选
   - **showPlayerCount**: ✅ 勾选

---

## 5. 创建远程玩家预制体

### 5.1 创建预制体文件

1. 在Assets面板，找到你的玩家模型预制体
   - 例如：`assets/prefabs/SurvivorPlayer.prefab`
2. 右键 → **"复制"**
3. 重命名为 `RemotePlayer.prefab`

**或者新建预制体**：
1. 在场景中创建空节点，命名 `RemotePlayer`
2. 添加子节点：
   - 你的角色模型 (FBX/glTF)
   - Animation组件（如果有动画）
3. 拖拽到Assets面板 `assets/prefabs/` 文件夹，生成预制体
4. 删除场景中的临时节点

---

### 5.2 配置预制体

1. 双击 `RemotePlayer.prefab` 进入编辑模式
2. 选中根节点 `RemotePlayer`
3. 添加组件 → 自定义组件 → **RemotePlayerController**
4. 配置RemotePlayerController组件：

| 属性 | 推荐值 | 说明 |
|------|-------|------|
| **interpolationSpeed** | 10.0 | 插值速度（越大越快） |
| **snapThreshold** | 5.0 | 传送阈值（米） |
| **enableSmoothing** | ✅ 勾选 | 启用平滑移动 |
| **showDebugInfo** | ✅ 勾选（测试时） | 显示调试信息 |

5. 保存预制体 (Ctrl+S / Cmd+S)
6. 退出预制体编辑模式

---

### 5.3 配置远程玩家管理器

回到GameScene：

1. 右键Canvas（或场景根节点） → **"创建空节点"** → 命名 `RemotePlayerManager`
2. 添加组件 → 自定义组件 → **RemotePlayerManager**
3. 配置组件：

| 属性 | 拖拽目标 | 说明 |
|------|---------|------|
| **remotePlayerPrefab** | RemotePlayer.prefab | 远程玩家预制体 |
| **playersContainer** | 场景中的Players节点（可选） | 玩家容器节点 |

4. 配置属性：
   - **enableDebugLog**: ✅ 勾选（测试时）

**说明**：
- `playersContainer` 是可选的，如果不设置，远程玩家会直接创建在场景根节点
- 建议创建一个空节点 `Players` 作为容器，方便管理

---

## 6. 配置本地玩家同步

### 6.1 找到本地玩家节点

在GameScene中，找到你的本地玩家节点：
- 可能叫 `Player`, `LocalPlayer`, `MainPlayer` 等
- 通常是有 `PlayerController` 组件的节点

---

### 6.2 添加PlayerSyncController组件

1. 选中本地玩家节点
2. 添加组件 → 自定义组件 → **PlayerSyncController**
3. 配置组件：

| 属性 | 推荐值 | 说明 |
|------|-------|------|
| **syncInterval** | 0.05 | 同步间隔（秒），默认20次/秒 |
| **positionThreshold** | 0.01 | 位置变化阈值（米） |
| **rotationThreshold** | 1.0 | 旋转变化阈值（度） |
| **enableDebugLog** | ✅ 勾选（测试时） | 显示调试日志 |

---

### 6.3 验证PlayerController兼容性

**检查你的PlayerController脚本**是否有 `isMoving()` 方法：

```typescript
// 你的PlayerController.ts中应该有：
export class PlayerController extends Component {
    // ...

    public isMoving(): boolean {
        // 返回玩家是否正在移动
        return this._isMoving; // 或其他判断逻辑
    }
}
```

**如果没有此方法**：
- PlayerSyncController会通过位置变化自动判断移动状态
- 但建议添加此方法以获得更准确的状态

---

## 7. 测试网络连接

### 7.1 启动服务器

**参见《任务4.1_服务器部署指南.md》**

快速启动：
```bash
cd /Users/clare/Desktop/前哨AI小课/ClareProject/Cute-Pet-Escape-Project/server
npm run dev
```

预期输出：
```
✅ Server is running on http://localhost:2567
```

---

### 7.2 测试大厅场景

1. 在Cocos Creator中打开 `LobbyScene`
2. 点击 **"运行场景"**
3. 检查Console输出：
   ```
   [NetworkManager] 网络管理器初始化
   [NetworkManager] Colyseus客户端创建成功
   [LobbyUI] 大厅UI初始化
   [LobbyUI] 生成随机玩家名: 快乐的小猫42
   ```

4. 点击 **"创建房间"** 按钮
5. 预期效果：
   - StatusLabel显示 "连接中..."
   - Console显示：
     ```
     [NetworkManager] 正在创建房间...
     [NetworkManager] 房间创建成功: <房间ID>
     [LobbyUI] 房间创建成功，房间ID: <房间ID>
     ```
   - 1秒后自动跳转到GameScene

---

### 7.3 测试游戏场景

**测试1：单人房间**

1. 创建房间后，应该看到GameScene
2. 检查RoomUI显示：
   - "房间ID: xxxx"
   - "玩家: 1/5"
   - "已连接"
3. 移动你的角色
4. Console应该显示同步日志：
   ```
   [PlayerSyncController] 同步状态: pos(1.23, 0.00), rot(45.0), moving(true)
   ```

**测试2：查看服务器**

1. 打开浏览器，访问：`http://localhost:2567/rooms`
2. 应该看到JSON响应：
   ```json
   {
     "success": true,
     "rooms": [
       {
         "roomId": "xxxxx",
         "clients": 1,
         "maxClients": 5,
         "metadata": {
           "roomName": "快乐的小猫42的房间"
         }
       }
     ]
   }
   ```

---

### 7.4 测试双人联机

**准备两个客户端**：

**方法1：两个浏览器窗口（最简单）**
1. 在Cocos Creator中，运行游戏
2. 点击"创建房间"，记下房间ID（例如：`abc123`）
3. 浏览器会自动打开游戏
4. **再次点击Cocos Creator的运行按钮**（会打开新窗口）
5. 在第二个窗口中，输入房间ID `abc123`，点击"加入"

**方法2：构建Web版本**
1. Cocos Creator → 项目 → 构建发布
2. 平台：Web Mobile
3. 点击"构建"
4. 构建完成后，点击"运行"
5. 会在浏览器中打开游戏
6. 再打开一个新浏览器窗口，访问相同地址

**预期效果**：
- ✅ 第一个玩家创建房间
- ✅ 第二个玩家输入房间ID加入
- ✅ 两个玩家都能看到对方的角色模型
- ✅ 移动时，对方能看到实时移动
- ✅ RoomUI显示"玩家: 2/5"

**Console输出（第一个玩家）**：
```
[NetworkManager] 房间创建成功: abc123
[RemotePlayerManager] 新玩家加入: <sessionId>
[RemotePlayerManager] 创建远程玩家成功: 勇敢的小狗88 (<sessionId>)
```

**Console输出（第二个玩家）**：
```
[NetworkManager] 成功加入房间: abc123
[RemotePlayerManager] 当前房间有 2 个玩家
[RemotePlayerManager] 创建远程玩家成功: 快乐的小猫42 (<sessionId>)
```

---

## 8. 常见问题排查

### 问题1：点击"创建房间"后无响应

**检查清单**：
1. ✅ 服务器是否正在运行？
   - 打开终端，查看服务器Console
   - 访问 `http://localhost:2567/` 是否有响应

2. ✅ NetworkManager的serverUrl是否正确？
   - 应该是 `ws://localhost:2567`
   - 不是 `http://` 而是 `ws://`

3. ✅ LobbyUI组件是否正确配置？
   - 检查所有引用是否已拖拽
   - 检查按钮事件是否绑定

---

### 问题2：加入房间失败

**错误信息**：`Room "abc123" not found`

**原因**：
- 房间ID输入错误（区分大小写）
- 房间已满员
- 房间已关闭

**解决方案**：
1. 仔细核对房间ID（建议复制粘贴）
2. 访问 `http://localhost:2567/rooms` 查看可用房间
3. 创建新房间

---

### 问题3：看不到远程玩家

**检查清单**：
1. ✅ RemotePlayerManager是否正确配置？
   - `remotePlayerPrefab` 是否已设置
   - Console是否显示"创建远程玩家成功"

2. ✅ 远程玩家预制体是否正确？
   - 预制体中是否有可见的模型
   - 是否添加了RemotePlayerController组件

3. ✅ 检查玩家位置
   - 远程玩家可能在视野外
   - 查看Scene视图中是否有远程玩家节点

---

### 问题4：远程玩家不会移动

**检查清单**：
1. ✅ PlayerSyncController是否正确挂载在本地玩家上？
2. ✅ 检查Console是否有同步日志：
   ```
   [PlayerSyncController] 同步状态: pos(...), moving(true)
   ```
3. ✅ RemotePlayerController的enableSmoothing是否勾选？
4. ✅ 检查服务器Console是否收到playerMove消息

**调试方法**：
```typescript
// 在RemotePlayerController.ts的updatePlayerState方法中添加：
console.log(`更新远程玩家位置: (${playerData.x}, ${playerData.y}, ${playerData.z})`);
```

---

### 问题5：Colyseus未定义

**错误信息**：`ReferenceError: Colyseus is not defined`

**解决方案**：
1. 检查 `colyseus.js` 是否在 `assets/libs/` 目录
2. 检查 `colyseus.js` 是否勾选"作为插件导入"
3. 在 `NetworkManager.ts` 顶部添加：
   ```typescript
   declare const Colyseus: any;
   ```
4. 重启Cocos Creator

---

### 问题6：场景切换后断开连接

**原因**：NetworkManager没有持久化

**解决方案**：
已在NetworkManager中实现了持久化：
```typescript
onLoad() {
    // 设置为常驻节点（跨场景保留）
    director.addPersistRootNode(this.node);
}
```

**验证**：
- 从LobbyScene切换到GameScene
- Console不应该出现"连接断开"
- NetworkManager节点应该保留在层级面板中

---

## 9. 性能优化建议

### 9.1 调整同步频率

**根据实际网络情况调整**：

```typescript
// PlayerSyncController组件
syncInterval: 0.05  // 默认20次/秒

// 如果网络延迟高，可以降低频率：
syncInterval: 0.1   // 10次/秒
```

---

### 9.2 启用对象池

**优化远程玩家的创建/销毁**：

```typescript
// 在RemotePlayerManager中实现对象池
private _playerPool: Node[] = [];

private getPlayerFromPool(): Node {
    if (this._playerPool.length > 0) {
        return this._playerPool.pop()!;
    }
    return instantiate(this.remotePlayerPrefab!);
}

private returnPlayerToPool(node: Node) {
    node.active = false;
    this._playerPool.push(node);
}
```

---

### 9.3 减少日志输出

**生产环境关闭调试日志**：

- NetworkManager: `enableDebugLog = false`
- RemotePlayerManager: `enableDebugLog = false`
- PlayerSyncController: `enableDebugLog = false`
- RemotePlayerController: `showDebugInfo = false`

---

## 10. 下一步

客户端配置完成后：
1. ✅ 参见《任务4.1_服务器部署指南.md》启动服务器
2. ✅ 参见《任务4.1_联机测试指南.md》进行完整测试
3. ✅ 开始【任务4.2】：实现游戏玩法的网络同步

---

**文档生成时间**：2025-10-03
**适用版本**：Cocos Creator 3.6.x+, Colyseus 0.15.x
**配置状态**：✅ 客户端配置就绪
