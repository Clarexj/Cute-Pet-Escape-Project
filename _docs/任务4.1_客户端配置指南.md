# ä»»åŠ¡4.1ï¼šå®¢æˆ·ç«¯é…ç½®æŒ‡å—ï¼ˆCocos Creatorï¼‰

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šV4.1
**åˆ›å»ºæ—¥æœŸ**ï¼š2025-10-03
**æŠ€æœ¯æ–¹æ¡ˆ**ï¼šColyseus + Cocos Creator

---

## ğŸ“‹ ç›®å½•

1. [å®‰è£…Colyseuså®¢æˆ·ç«¯åº“](#1-å®‰è£…colyseuså®¢æˆ·ç«¯åº“)
2. [åˆ›å»ºç½‘ç»œè„šæœ¬ç»„ä»¶](#2-åˆ›å»ºç½‘ç»œè„šæœ¬ç»„ä»¶)
3. [åˆ›å»ºå¤§å…åœºæ™¯(LobbyScene)](#3-åˆ›å»ºå¤§å…åœºæ™¯lobbyscene)
4. [é…ç½®æ¸¸æˆåœºæ™¯(GameScene)](#4-é…ç½®æ¸¸æˆåœºæ™¯gamescene)
5. [åˆ›å»ºè¿œç¨‹ç©å®¶é¢„åˆ¶ä½“](#5-åˆ›å»ºè¿œç¨‹ç©å®¶é¢„åˆ¶ä½“)
6. [é…ç½®æœ¬åœ°ç©å®¶åŒæ­¥](#6-é…ç½®æœ¬åœ°ç©å®¶åŒæ­¥)
7. [æµ‹è¯•ç½‘ç»œè¿æ¥](#7-æµ‹è¯•ç½‘ç»œè¿æ¥)

---

## 1. å®‰è£…Colyseuså®¢æˆ·ç«¯åº“

### 1.1 ä¸‹è½½Colyseus.js

**æ–¹æ³•1ï¼šä½¿ç”¨CDNï¼ˆæ¨èï¼‰**

1. è®¿é—®ï¼šhttps://unpkg.com/colyseus.js@0.15.0/dist/colyseus.js
2. æµè§ˆå™¨ä¼šæ˜¾ç¤ºJavaScriptä»£ç 
3. æŒ‰ `Ctrl+S` (Windows) æˆ– `Cmd+S` (Mac) ä¿å­˜æ–‡ä»¶
4. ä¿å­˜åˆ°é¡¹ç›®è·¯å¾„ï¼š
   ```
   /Users/clare/Desktop/å‰å“¨AIå°è¯¾/ClareProject/Cute-Pet-Escape-Project/CocosProject/assets/libs/colyseus.js
   ```

**æ–¹æ³•2ï¼šä½¿ç”¨npmï¼ˆå¦‚æœä½ æœ‰Node.jsï¼‰**

```bash
cd /Users/clare/Desktop/å‰å“¨AIå°è¯¾/ClareProject/Cute-Pet-Escape-Project/CocosProject

# åˆ›å»ºlibsæ–‡ä»¶å¤¹
mkdir -p assets/libs

# ä¸‹è½½Colyseus
npm install colyseus.js@0.15.0

# å¤åˆ¶åˆ°assets
cp node_modules/colyseus.js/dist/colyseus.js assets/libs/
```

---

### 1.2 åœ¨Cocos Creatorä¸­å¯¼å…¥

1. **æ‰“å¼€Cocos Creator**
2. **æ‰“å¼€é¡¹ç›®**ï¼š`Cute-Pet-Escape-Project/CocosProject`
3. **æ£€æŸ¥Assetsé¢æ¿**ï¼š
   - åº”è¯¥çœ‹åˆ° `assets/libs/colyseus.js`
   - å¦‚æœæ²¡æœ‰ï¼Œç‚¹å‡»Assetsé¢æ¿å³é”® â†’ "é‡æ–°å¯¼å…¥èµ„æº"

4. **é…ç½®ä¸ºæ’ä»¶**ï¼š
   - é€‰ä¸­ `colyseus.js` æ–‡ä»¶
   - åœ¨å±æ€§æ£€æŸ¥å™¨(Properties)ä¸­
   - å‹¾é€‰ **"ä½œä¸ºæ’ä»¶å¯¼å…¥"** (Import As Plugin)
   - ç‚¹å‡»å³ä¸Šè§’ **"åº”ç”¨"** (Apply)

![Colyseusé…ç½®ç¤ºä¾‹](https://docs.cocos.com/creator/manual/zh/scripting/plugin-scripts.html)

---

### 1.3 éªŒè¯å®‰è£…

**åˆ›å»ºæµ‹è¯•è„šæœ¬**ï¼ˆå¯é€‰ï¼‰ï¼š

```typescript
// ä¸´æ—¶æµ‹è¯•æ–‡ä»¶ï¼šassets/scripts/test/NetworkTest.ts
import { _decorator, Component } from 'cc';
const { ccclass } = _decorator;

@ccclass('NetworkTest')
export class NetworkTest extends Component {
    start() {
        // æ£€æŸ¥Colyseusæ˜¯å¦å¯ç”¨
        if (typeof Colyseus !== 'undefined') {
            console.log('âœ… Colyseusåº“åŠ è½½æˆåŠŸï¼');
            console.log('Colyseusç‰ˆæœ¬:', Colyseus.version);
        } else {
            console.error('âŒ Colyseusåº“æœªæ‰¾åˆ°ï¼');
        }
    }
}
```

**è¿è¡Œæµ‹è¯•**ï¼š
1. åˆ›å»ºç©ºèŠ‚ç‚¹ï¼ŒæŒ‚è½½ `NetworkTest` ç»„ä»¶
2. è¿è¡Œåœºæ™¯
3. æŸ¥çœ‹Consoleè¾“å‡ºï¼šåº”è¯¥çœ‹åˆ° "âœ… Colyseusåº“åŠ è½½æˆåŠŸï¼"

---

## 2. åˆ›å»ºç½‘ç»œè„šæœ¬ç»„ä»¶

æ‰€æœ‰è„šæœ¬æ–‡ä»¶å·²åœ¨ `CocosProject/assets/scripts/` ç›®å½•ä¸‹åˆ›å»ºï¼š

### 2.1 æ–‡ä»¶åˆ—è¡¨

**ç½‘ç»œæ ¸å¿ƒ**ï¼š
- `network/NetworkManager.ts` - ç½‘ç»œç®¡ç†å™¨ï¼ˆå•ä¾‹ï¼‰
- `network/PlayerSyncController.ts` - æœ¬åœ°ç©å®¶åŒæ­¥
- `network/RemotePlayerController.ts` - è¿œç¨‹ç©å®¶æ§åˆ¶
- `network/RemotePlayerManager.ts` - è¿œç¨‹ç©å®¶ç®¡ç†å™¨

**UIç•Œé¢**ï¼š
- `ui/LobbyUI.ts` - å¤§å…UI
- `ui/RoomUI.ts` - æˆ¿é—´UI

### 2.2 éªŒè¯è„šæœ¬å¯¼å…¥

1. åœ¨Cocos Creatorä¸­æ‰“å¼€ **"èµ„æºç®¡ç†å™¨"** (Assets)
2. å±•å¼€ `assets/scripts/network/` å’Œ `assets/scripts/ui/`
3. æ£€æŸ¥æ‰€æœ‰è„šæœ¬æ–‡ä»¶æ˜¯å¦å­˜åœ¨
4. å¦‚æœæœ‰ç¼–è¯‘é”™è¯¯ï¼ŒæŸ¥çœ‹ **"æ§åˆ¶å°"** (Console)

**å¸¸è§é”™è¯¯ä¿®å¤**ï¼š

- **é”™è¯¯1**ï¼š`Cannot find module 'colyseus.js'`
  - **è§£å†³**ï¼šæ£€æŸ¥æ­¥éª¤1.2ï¼Œç¡®ä¿colyseus.jså·²å¯¼å…¥å¹¶æ ‡è®°ä¸ºæ’ä»¶

- **é”™è¯¯2**ï¼š`Property 'Colyseus' does not exist on type 'Window'`
  - **è§£å†³**ï¼šåœ¨ `NetworkManager.ts` é¡¶éƒ¨æ·»åŠ ï¼š
    ```typescript
    declare const Colyseus: any;
    ```

---

## 3. åˆ›å»ºå¤§å…åœºæ™¯(LobbyScene)

### 3.1 åˆ›å»ºåœºæ™¯æ–‡ä»¶

1. åœ¨Assetsé¢æ¿ï¼Œå³é”® â†’ **"æ–°å»ºåœºæ™¯"** (New Scene)
2. å‘½åä¸º `LobbyScene`
3. ä¿å­˜åˆ°ï¼š`assets/scenes/LobbyScene.scene`

---

### 3.2 åˆ›å»ºUIç»“æ„

**åœºæ™¯å±‚çº§ç»“æ„**ï¼š

```
LobbyScene
â”œâ”€â”€ Canvas (å·²æœ‰)
â”‚   â”œâ”€â”€ Camera (å·²æœ‰)
â”‚   â””â”€â”€ LobbyPanel (æ–°å»º Node)
â”‚       â”œâ”€â”€ TitleLabel (æ–°å»º Label)
â”‚       â”œâ”€â”€ PlayerNamePanel (æ–°å»º Node)
â”‚       â”‚   â”œâ”€â”€ NameLabel (æ–°å»º Label)
â”‚       â”‚   â”œâ”€â”€ NameInput (æ–°å»º EditBox)
â”‚       â”‚   â””â”€â”€ RandomButton (æ–°å»º Button)
â”‚       â”œâ”€â”€ CreateRoomButton (æ–°å»º Button)
â”‚       â”œâ”€â”€ JoinRoomPanel (æ–°å»º Node)
â”‚       â”‚   â”œâ”€â”€ RoomIdLabel (æ–°å»º Label)
â”‚       â”‚   â”œâ”€â”€ RoomIdInput (æ–°å»º EditBox)
â”‚       â”‚   â””â”€â”€ JoinButton (æ–°å»º Button)
â”‚       â”œâ”€â”€ StatusLabel (æ–°å»º Label)
â”‚       â””â”€â”€ LoadingPanel (æ–°å»º Node)
â”‚           â””â”€â”€ LoadingLabel (æ–°å»º Label)
â””â”€â”€ NetworkManager (æ–°å»º Node)
```

---

### 3.3 è¯¦ç»†é…ç½®æ­¥éª¤

#### æ­¥éª¤1ï¼šåˆ›å»ºNetworkManagerèŠ‚ç‚¹

1. å³é”®Canvas â†’ **"åˆ›å»ºç©ºèŠ‚ç‚¹"** â†’ å‘½å `NetworkManager`
2. é€‰ä¸­ `NetworkManager` èŠ‚ç‚¹
3. åœ¨å±æ€§æ£€æŸ¥å™¨ï¼Œç‚¹å‡» **"æ·»åŠ ç»„ä»¶"** â†’ **"è‡ªå®šä¹‰ç»„ä»¶"** â†’ é€‰æ‹© `NetworkManager`
4. é…ç½®NetworkManagerç»„ä»¶ï¼š
   - **Server Url**: `ws://localhost:2567` (æœ¬åœ°æµ‹è¯•)
   - **Auto Connect**: âœ… å‹¾é€‰
   - **Enable Debug Log**: âœ… å‹¾é€‰

#### æ­¥éª¤2ï¼šåˆ›å»ºLobbyPanel

1. å³é”®Canvas â†’ **"åˆ›å»ºç©ºèŠ‚ç‚¹"** â†’ å‘½å `LobbyPanel`
2. è®¾ç½®LobbyPanelçš„Widgetç»„ä»¶ï¼ˆè®©UIé€‚é…å±å¹•ï¼‰ï¼š
   - æ·»åŠ ç»„ä»¶ â†’ UI â†’ **Widget**
   - Left: 0, Right: 0, Top: 0, Bottom: 0
   - å‹¾é€‰ **"å¯¹é½ç›®æ ‡"** (Align Target): Canvas

#### æ­¥éª¤3ï¼šåˆ›å»ºæ ‡é¢˜(TitleLabel)

1. å³é”®LobbyPanel â†’ **"åˆ›å»ºUIèŠ‚ç‚¹"** â†’ **Label**
2. å‘½åä¸º `TitleLabel`
3. é…ç½®Labelç»„ä»¶ï¼š
   - **String**: "å¯çˆ±å® ç‰©å¤§é€ƒæ€ - è”æœºå¤§å…"
   - **Font Size**: 48
   - **Color**: ç™½è‰²
4. é…ç½®Transformï¼š
   - Position: (0, 300, 0)

#### æ­¥éª¤4ï¼šåˆ›å»ºç©å®¶åç§°è¾“å…¥åŒº(PlayerNamePanel)

1. å³é”®LobbyPanel â†’ **"åˆ›å»ºç©ºèŠ‚ç‚¹"** â†’ å‘½å `PlayerNamePanel`
2. Position: (0, 150, 0)

**å­å…ƒç´ Aï¼šNameLabel**
- åˆ›å»ºLabelèŠ‚ç‚¹ï¼Œå‘½å `NameLabel`
- String: "ç©å®¶åç§°ï¼š"
- Position: (-150, 0, 0)

**å­å…ƒç´ Bï¼šNameInput**
- åˆ›å»ºEditBoxèŠ‚ç‚¹ï¼Œå‘½å `NameInput`
- Position: (0, 0, 0)
- Placeholder: "è¾“å…¥ä½ çš„åå­—"
- Max Length: 20
- Background Image: éœ€è¦æ·»åŠ ä¸€ä¸ªSpriteèƒŒæ™¯ï¼ˆå¯ç”¨ç™½è‰²æ–¹å—ï¼‰

**å­å…ƒç´ Cï¼šRandomButton**
- åˆ›å»ºButtonèŠ‚ç‚¹ï¼Œå‘½å `RandomButton`
- Position: (150, 0, 0)
- Labelæ–‡å­—: "éšæœº"
- Size: (120, 50)

#### æ­¥éª¤5ï¼šåˆ›å»ºæˆ¿é—´æŒ‰é’®

**A. CreateRoomButton**
1. å³é”®LobbyPanel â†’ **"åˆ›å»ºUIèŠ‚ç‚¹"** â†’ **Button**
2. å‘½å `CreateRoomButton`
3. Position: (0, 50, 0)
4. Size: (300, 60)
5. å­èŠ‚ç‚¹Labelçš„String: "åˆ›å»ºæˆ¿é—´"

**B. JoinRoomPanel**
1. å³é”®LobbyPanel â†’ **"åˆ›å»ºç©ºèŠ‚ç‚¹"** â†’ å‘½å `JoinRoomPanel`
2. Position: (0, -50, 0)

- **å­å…ƒç´ ï¼šRoomIdLabel**
  - åˆ›å»ºLabelï¼ŒString: "æˆ¿é—´IDï¼š"
  - Position: (-150, 0, 0)

- **å­å…ƒç´ ï¼šRoomIdInput**
  - åˆ›å»ºEditBox
  - Position: (-30, 0, 0)
  - Placeholder: "è¾“å…¥æˆ¿é—´ID"
  - Max Length: 30

- **å­å…ƒç´ ï¼šJoinButton**
  - åˆ›å»ºButton
  - Position: (120, 0, 0)
  - Labelæ–‡å­—: "åŠ å…¥"

#### æ­¥éª¤6ï¼šåˆ›å»ºçŠ¶æ€æ˜¾ç¤º

**StatusLabel**
- å³é”®LobbyPanel â†’ åˆ›å»ºLabel
- å‘½å `StatusLabel`
- Position: (0, -150, 0)
- String: ""
- Color: ç»¿è‰² (0, 255, 0, 255)

**LoadingPanel**
- å³é”®LobbyPanel â†’ åˆ›å»ºç©ºèŠ‚ç‚¹
- å‘½å `LoadingPanel`
- Position: (0, -200, 0)
- é»˜è®¤éšè—ï¼šActive = false

- **å­å…ƒç´ ï¼šLoadingLabel**
  - åˆ›å»ºLabel
  - String: "è¿æ¥ä¸­..."

---

### 3.4 æŒ‚è½½LobbyUIè„šæœ¬

1. é€‰ä¸­ `LobbyPanel` èŠ‚ç‚¹
2. æ·»åŠ ç»„ä»¶ â†’ è‡ªå®šä¹‰ç»„ä»¶ â†’ **LobbyUI**
3. é…ç½®LobbyUIç»„ä»¶ï¼ˆæ‹–æ‹½å¼•ç”¨ï¼‰ï¼š

| å±æ€§ | æ‹–æ‹½ç›®æ ‡èŠ‚ç‚¹ |
|------|-------------|
| **playerNameInput** | PlayerNamePanel/NameInput |
| **randomNameButton** | PlayerNamePanel/RandomButton |
| **createRoomButton** | CreateRoomButton |
| **roomIdInput** | JoinRoomPanel/RoomIdInput |
| **joinRoomButton** | JoinRoomPanel/JoinButton |
| **statusLabel** | StatusLabel |
| **loadingPanel** | LoadingPanel |

4. é…ç½®å…¶ä»–å±æ€§ï¼š
   - **autoGeneratePlayerName**: âœ… å‹¾é€‰
   - **gameSceneName**: "GameScene"

---

### 3.5 æµ‹è¯•å¤§å…åœºæ™¯

1. ä¿å­˜åœºæ™¯ (Ctrl+S / Cmd+S)
2. ç‚¹å‡» **"è¿è¡Œåœºæ™¯"** (æ’­æ”¾æŒ‰é’®)
3. é¢„æœŸæ•ˆæœï¼š
   - âœ… çœ‹åˆ°"å¯çˆ±å® ç‰©å¤§é€ƒæ€ - è”æœºå¤§å…"æ ‡é¢˜
   - âœ… ç©å®¶åç§°è¾“å…¥æ¡†æœ‰éšæœºåå­—
   - âœ… "åˆ›å»ºæˆ¿é—´"å’Œ"åŠ å…¥"æŒ‰é’®å¯è§
   - âœ… Consoleæ˜¾ç¤ºï¼š"[NetworkManager] ç½‘ç»œç®¡ç†å™¨åˆå§‹åŒ–"

**å¦‚æœç‚¹å‡»"åˆ›å»ºæˆ¿é—´"**ï¼š
- åº”è¯¥çœ‹åˆ°StatusLabelæ˜¾ç¤º"è¿æ¥ä¸­..."
- å¦‚æœæœåŠ¡å™¨æœªå¯åŠ¨ï¼Œä¼šæ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
- ï¼ˆæ­¤æ—¶å…ˆä¸æµ‹è¯•ï¼Œç­‰æœåŠ¡å™¨å¯åŠ¨åå†æµ‹ï¼‰

---

## 4. é…ç½®æ¸¸æˆåœºæ™¯(GameScene)

### 4.1 æ‰“å¼€ç°æœ‰æ¸¸æˆåœºæ™¯

1. åœ¨Assetsé¢æ¿ï¼Œæ‰¾åˆ° `assets/scenes/GameScene.scene`
2. åŒå‡»æ‰“å¼€

---

### 4.2 æ·»åŠ æˆ¿é—´UI

**åˆ›å»ºRoomUIPanel**ï¼š

1. å³é”®Canvas â†’ **"åˆ›å»ºç©ºèŠ‚ç‚¹"** â†’ å‘½å `RoomUIPanel`
2. æ·»åŠ Widgetç»„ä»¶ï¼š
   - Top: 10, Left: 10
   - å‹¾é€‰ **"å¯¹é½é¡¶éƒ¨"** å’Œ **"å¯¹é½å·¦ä¾§"**

**å­å…ƒç´ ç»“æ„**ï¼š
```
RoomUIPanel
â”œâ”€â”€ RoomIdLabel (Label)
â”œâ”€â”€ PlayerCountLabel (Label)
â”œâ”€â”€ StatusLabel (Label)
â””â”€â”€ LeaveRoomButton (Button) [å¯é€‰]
```

**é…ç½®ç¤ºä¾‹**ï¼š

**RoomIdLabel**ï¼š
- String: "æˆ¿é—´ID: ----"
- Position: (0, 0, 0)
- Anchor: å·¦ä¸Šè§’

**PlayerCountLabel**ï¼š
- String: "ç©å®¶: 1/5"
- Position: (0, -40, 0)

**StatusLabel**ï¼š
- String: "å·²è¿æ¥"
- Position: (0, -80, 0)
- Color: ç»¿è‰²

---

### 4.3 æŒ‚è½½RoomUIè„šæœ¬

1. é€‰ä¸­ `RoomUIPanel` èŠ‚ç‚¹
2. æ·»åŠ ç»„ä»¶ â†’ è‡ªå®šä¹‰ç»„ä»¶ â†’ **RoomUI**
3. é…ç½®RoomUIç»„ä»¶ï¼š

| å±æ€§ | æ‹–æ‹½ç›®æ ‡ |
|------|---------|
| **roomIdLabel** | RoomIdLabel |
| **playerCountLabel** | PlayerCountLabel |
| **statusLabel** | StatusLabel |
| **leaveRoomButton** | LeaveRoomButtonï¼ˆå¦‚æœæœ‰ï¼‰ |

4. é…ç½®å±æ€§ï¼š
   - **showRoomId**: âœ… å‹¾é€‰
   - **showPlayerCount**: âœ… å‹¾é€‰

---

## 5. åˆ›å»ºè¿œç¨‹ç©å®¶é¢„åˆ¶ä½“

### 5.1 åˆ›å»ºé¢„åˆ¶ä½“æ–‡ä»¶

1. åœ¨Assetsé¢æ¿ï¼Œæ‰¾åˆ°ä½ çš„ç©å®¶æ¨¡å‹é¢„åˆ¶ä½“
   - ä¾‹å¦‚ï¼š`assets/prefabs/SurvivorPlayer.prefab`
2. å³é”® â†’ **"å¤åˆ¶"**
3. é‡å‘½åä¸º `RemotePlayer.prefab`

**æˆ–è€…æ–°å»ºé¢„åˆ¶ä½“**ï¼š
1. åœ¨åœºæ™¯ä¸­åˆ›å»ºç©ºèŠ‚ç‚¹ï¼Œå‘½å `RemotePlayer`
2. æ·»åŠ å­èŠ‚ç‚¹ï¼š
   - ä½ çš„è§’è‰²æ¨¡å‹ (FBX/glTF)
   - Animationç»„ä»¶ï¼ˆå¦‚æœæœ‰åŠ¨ç”»ï¼‰
3. æ‹–æ‹½åˆ°Assetsé¢æ¿ `assets/prefabs/` æ–‡ä»¶å¤¹ï¼Œç”Ÿæˆé¢„åˆ¶ä½“
4. åˆ é™¤åœºæ™¯ä¸­çš„ä¸´æ—¶èŠ‚ç‚¹

---

### 5.2 é…ç½®é¢„åˆ¶ä½“

1. åŒå‡» `RemotePlayer.prefab` è¿›å…¥ç¼–è¾‘æ¨¡å¼
2. é€‰ä¸­æ ¹èŠ‚ç‚¹ `RemotePlayer`
3. æ·»åŠ ç»„ä»¶ â†’ è‡ªå®šä¹‰ç»„ä»¶ â†’ **RemotePlayerController**
4. é…ç½®RemotePlayerControllerç»„ä»¶ï¼š

| å±æ€§ | æ¨èå€¼ | è¯´æ˜ |
|------|-------|------|
| **interpolationSpeed** | 10.0 | æ’å€¼é€Ÿåº¦ï¼ˆè¶Šå¤§è¶Šå¿«ï¼‰ |
| **snapThreshold** | 5.0 | ä¼ é€é˜ˆå€¼ï¼ˆç±³ï¼‰ |
| **enableSmoothing** | âœ… å‹¾é€‰ | å¯ç”¨å¹³æ»‘ç§»åŠ¨ |
| **showDebugInfo** | âœ… å‹¾é€‰ï¼ˆæµ‹è¯•æ—¶ï¼‰ | æ˜¾ç¤ºè°ƒè¯•ä¿¡æ¯ |

5. ä¿å­˜é¢„åˆ¶ä½“ (Ctrl+S / Cmd+S)
6. é€€å‡ºé¢„åˆ¶ä½“ç¼–è¾‘æ¨¡å¼

---

### 5.3 é…ç½®è¿œç¨‹ç©å®¶ç®¡ç†å™¨

å›åˆ°GameSceneï¼š

1. å³é”®Canvasï¼ˆæˆ–åœºæ™¯æ ¹èŠ‚ç‚¹ï¼‰ â†’ **"åˆ›å»ºç©ºèŠ‚ç‚¹"** â†’ å‘½å `RemotePlayerManager`
2. æ·»åŠ ç»„ä»¶ â†’ è‡ªå®šä¹‰ç»„ä»¶ â†’ **RemotePlayerManager**
3. é…ç½®ç»„ä»¶ï¼š

| å±æ€§ | æ‹–æ‹½ç›®æ ‡ | è¯´æ˜ |
|------|---------|------|
| **remotePlayerPrefab** | RemotePlayer.prefab | è¿œç¨‹ç©å®¶é¢„åˆ¶ä½“ |
| **playersContainer** | åœºæ™¯ä¸­çš„PlayersèŠ‚ç‚¹ï¼ˆå¯é€‰ï¼‰ | ç©å®¶å®¹å™¨èŠ‚ç‚¹ |

4. é…ç½®å±æ€§ï¼š
   - **enableDebugLog**: âœ… å‹¾é€‰ï¼ˆæµ‹è¯•æ—¶ï¼‰

**è¯´æ˜**ï¼š
- `playersContainer` æ˜¯å¯é€‰çš„ï¼Œå¦‚æœä¸è®¾ç½®ï¼Œè¿œç¨‹ç©å®¶ä¼šç›´æ¥åˆ›å»ºåœ¨åœºæ™¯æ ¹èŠ‚ç‚¹
- å»ºè®®åˆ›å»ºä¸€ä¸ªç©ºèŠ‚ç‚¹ `Players` ä½œä¸ºå®¹å™¨ï¼Œæ–¹ä¾¿ç®¡ç†

---

## 6. é…ç½®æœ¬åœ°ç©å®¶åŒæ­¥

### 6.1 æ‰¾åˆ°æœ¬åœ°ç©å®¶èŠ‚ç‚¹

åœ¨GameSceneä¸­ï¼Œæ‰¾åˆ°ä½ çš„æœ¬åœ°ç©å®¶èŠ‚ç‚¹ï¼š
- å¯èƒ½å« `Player`, `LocalPlayer`, `MainPlayer` ç­‰
- é€šå¸¸æ˜¯æœ‰ `PlayerController` ç»„ä»¶çš„èŠ‚ç‚¹

---

### 6.2 æ·»åŠ PlayerSyncControllerç»„ä»¶

1. é€‰ä¸­æœ¬åœ°ç©å®¶èŠ‚ç‚¹
2. æ·»åŠ ç»„ä»¶ â†’ è‡ªå®šä¹‰ç»„ä»¶ â†’ **PlayerSyncController**
3. é…ç½®ç»„ä»¶ï¼š

| å±æ€§ | æ¨èå€¼ | è¯´æ˜ |
|------|-------|------|
| **syncInterval** | 0.05 | åŒæ­¥é—´éš”ï¼ˆç§’ï¼‰ï¼Œé»˜è®¤20æ¬¡/ç§’ |
| **positionThreshold** | 0.01 | ä½ç½®å˜åŒ–é˜ˆå€¼ï¼ˆç±³ï¼‰ |
| **rotationThreshold** | 1.0 | æ—‹è½¬å˜åŒ–é˜ˆå€¼ï¼ˆåº¦ï¼‰ |
| **enableDebugLog** | âœ… å‹¾é€‰ï¼ˆæµ‹è¯•æ—¶ï¼‰ | æ˜¾ç¤ºè°ƒè¯•æ—¥å¿— |

---

### 6.3 éªŒè¯PlayerControllerå…¼å®¹æ€§

**æ£€æŸ¥ä½ çš„PlayerControllerè„šæœ¬**æ˜¯å¦æœ‰ `isMoving()` æ–¹æ³•ï¼š

```typescript
// ä½ çš„PlayerController.tsä¸­åº”è¯¥æœ‰ï¼š
export class PlayerController extends Component {
    // ...

    public isMoving(): boolean {
        // è¿”å›ç©å®¶æ˜¯å¦æ­£åœ¨ç§»åŠ¨
        return this._isMoving; // æˆ–å…¶ä»–åˆ¤æ–­é€»è¾‘
    }
}
```

**å¦‚æœæ²¡æœ‰æ­¤æ–¹æ³•**ï¼š
- PlayerSyncControllerä¼šé€šè¿‡ä½ç½®å˜åŒ–è‡ªåŠ¨åˆ¤æ–­ç§»åŠ¨çŠ¶æ€
- ä½†å»ºè®®æ·»åŠ æ­¤æ–¹æ³•ä»¥è·å¾—æ›´å‡†ç¡®çš„çŠ¶æ€

---

## 7. æµ‹è¯•ç½‘ç»œè¿æ¥

### 7.1 å¯åŠ¨æœåŠ¡å™¨

**å‚è§ã€Šä»»åŠ¡4.1_æœåŠ¡å™¨éƒ¨ç½²æŒ‡å—.mdã€‹**

å¿«é€Ÿå¯åŠ¨ï¼š
```bash
cd /Users/clare/Desktop/å‰å“¨AIå°è¯¾/ClareProject/Cute-Pet-Escape-Project/server
npm run dev
```

é¢„æœŸè¾“å‡ºï¼š
```
âœ… Server is running on http://localhost:2567
```

---

### 7.2 æµ‹è¯•å¤§å…åœºæ™¯

1. åœ¨Cocos Creatorä¸­æ‰“å¼€ `LobbyScene`
2. ç‚¹å‡» **"è¿è¡Œåœºæ™¯"**
3. æ£€æŸ¥Consoleè¾“å‡ºï¼š
   ```
   [NetworkManager] ç½‘ç»œç®¡ç†å™¨åˆå§‹åŒ–
   [NetworkManager] Colyseuså®¢æˆ·ç«¯åˆ›å»ºæˆåŠŸ
   [LobbyUI] å¤§å…UIåˆå§‹åŒ–
   [LobbyUI] ç”Ÿæˆéšæœºç©å®¶å: å¿«ä¹çš„å°çŒ«42
   ```

4. ç‚¹å‡» **"åˆ›å»ºæˆ¿é—´"** æŒ‰é’®
5. é¢„æœŸæ•ˆæœï¼š
   - StatusLabelæ˜¾ç¤º "è¿æ¥ä¸­..."
   - Consoleæ˜¾ç¤ºï¼š
     ```
     [NetworkManager] æ­£åœ¨åˆ›å»ºæˆ¿é—´...
     [NetworkManager] æˆ¿é—´åˆ›å»ºæˆåŠŸ: <æˆ¿é—´ID>
     [LobbyUI] æˆ¿é—´åˆ›å»ºæˆåŠŸï¼Œæˆ¿é—´ID: <æˆ¿é—´ID>
     ```
   - 1ç§’åè‡ªåŠ¨è·³è½¬åˆ°GameScene

---

### 7.3 æµ‹è¯•æ¸¸æˆåœºæ™¯

**æµ‹è¯•1ï¼šå•äººæˆ¿é—´**

1. åˆ›å»ºæˆ¿é—´åï¼Œåº”è¯¥çœ‹åˆ°GameScene
2. æ£€æŸ¥RoomUIæ˜¾ç¤ºï¼š
   - "æˆ¿é—´ID: xxxx"
   - "ç©å®¶: 1/5"
   - "å·²è¿æ¥"
3. ç§»åŠ¨ä½ çš„è§’è‰²
4. Consoleåº”è¯¥æ˜¾ç¤ºåŒæ­¥æ—¥å¿—ï¼š
   ```
   [PlayerSyncController] åŒæ­¥çŠ¶æ€: pos(1.23, 0.00), rot(45.0), moving(true)
   ```

**æµ‹è¯•2ï¼šæŸ¥çœ‹æœåŠ¡å™¨**

1. æ‰“å¼€æµè§ˆå™¨ï¼Œè®¿é—®ï¼š`http://localhost:2567/rooms`
2. åº”è¯¥çœ‹åˆ°JSONå“åº”ï¼š
   ```json
   {
     "success": true,
     "rooms": [
       {
         "roomId": "xxxxx",
         "clients": 1,
         "maxClients": 5,
         "metadata": {
           "roomName": "å¿«ä¹çš„å°çŒ«42çš„æˆ¿é—´"
         }
       }
     ]
   }
   ```

---

### 7.4 æµ‹è¯•åŒäººè”æœº

**å‡†å¤‡ä¸¤ä¸ªå®¢æˆ·ç«¯**ï¼š

**æ–¹æ³•1ï¼šä¸¤ä¸ªæµè§ˆå™¨çª—å£ï¼ˆæœ€ç®€å•ï¼‰**
1. åœ¨Cocos Creatorä¸­ï¼Œè¿è¡Œæ¸¸æˆ
2. ç‚¹å‡»"åˆ›å»ºæˆ¿é—´"ï¼Œè®°ä¸‹æˆ¿é—´IDï¼ˆä¾‹å¦‚ï¼š`abc123`ï¼‰
3. æµè§ˆå™¨ä¼šè‡ªåŠ¨æ‰“å¼€æ¸¸æˆ
4. **å†æ¬¡ç‚¹å‡»Cocos Creatorçš„è¿è¡ŒæŒ‰é’®**ï¼ˆä¼šæ‰“å¼€æ–°çª—å£ï¼‰
5. åœ¨ç¬¬äºŒä¸ªçª—å£ä¸­ï¼Œè¾“å…¥æˆ¿é—´ID `abc123`ï¼Œç‚¹å‡»"åŠ å…¥"

**æ–¹æ³•2ï¼šæ„å»ºWebç‰ˆæœ¬**
1. Cocos Creator â†’ é¡¹ç›® â†’ æ„å»ºå‘å¸ƒ
2. å¹³å°ï¼šWeb Mobile
3. ç‚¹å‡»"æ„å»º"
4. æ„å»ºå®Œæˆåï¼Œç‚¹å‡»"è¿è¡Œ"
5. ä¼šåœ¨æµè§ˆå™¨ä¸­æ‰“å¼€æ¸¸æˆ
6. å†æ‰“å¼€ä¸€ä¸ªæ–°æµè§ˆå™¨çª—å£ï¼Œè®¿é—®ç›¸åŒåœ°å€

**é¢„æœŸæ•ˆæœ**ï¼š
- âœ… ç¬¬ä¸€ä¸ªç©å®¶åˆ›å»ºæˆ¿é—´
- âœ… ç¬¬äºŒä¸ªç©å®¶è¾“å…¥æˆ¿é—´IDåŠ å…¥
- âœ… ä¸¤ä¸ªç©å®¶éƒ½èƒ½çœ‹åˆ°å¯¹æ–¹çš„è§’è‰²æ¨¡å‹
- âœ… ç§»åŠ¨æ—¶ï¼Œå¯¹æ–¹èƒ½çœ‹åˆ°å®æ—¶ç§»åŠ¨
- âœ… RoomUIæ˜¾ç¤º"ç©å®¶: 2/5"

**Consoleè¾“å‡ºï¼ˆç¬¬ä¸€ä¸ªç©å®¶ï¼‰**ï¼š
```
[NetworkManager] æˆ¿é—´åˆ›å»ºæˆåŠŸ: abc123
[RemotePlayerManager] æ–°ç©å®¶åŠ å…¥: <sessionId>
[RemotePlayerManager] åˆ›å»ºè¿œç¨‹ç©å®¶æˆåŠŸ: å‹‡æ•¢çš„å°ç‹—88 (<sessionId>)
```

**Consoleè¾“å‡ºï¼ˆç¬¬äºŒä¸ªç©å®¶ï¼‰**ï¼š
```
[NetworkManager] æˆåŠŸåŠ å…¥æˆ¿é—´: abc123
[RemotePlayerManager] å½“å‰æˆ¿é—´æœ‰ 2 ä¸ªç©å®¶
[RemotePlayerManager] åˆ›å»ºè¿œç¨‹ç©å®¶æˆåŠŸ: å¿«ä¹çš„å°çŒ«42 (<sessionId>)
```

---

## 8. å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜1ï¼šç‚¹å‡»"åˆ›å»ºæˆ¿é—´"åæ— å“åº”

**æ£€æŸ¥æ¸…å•**ï¼š
1. âœ… æœåŠ¡å™¨æ˜¯å¦æ­£åœ¨è¿è¡Œï¼Ÿ
   - æ‰“å¼€ç»ˆç«¯ï¼ŒæŸ¥çœ‹æœåŠ¡å™¨Console
   - è®¿é—® `http://localhost:2567/` æ˜¯å¦æœ‰å“åº”

2. âœ… NetworkManagerçš„serverUrlæ˜¯å¦æ­£ç¡®ï¼Ÿ
   - åº”è¯¥æ˜¯ `ws://localhost:2567`
   - ä¸æ˜¯ `http://` è€Œæ˜¯ `ws://`

3. âœ… LobbyUIç»„ä»¶æ˜¯å¦æ­£ç¡®é…ç½®ï¼Ÿ
   - æ£€æŸ¥æ‰€æœ‰å¼•ç”¨æ˜¯å¦å·²æ‹–æ‹½
   - æ£€æŸ¥æŒ‰é’®äº‹ä»¶æ˜¯å¦ç»‘å®š

---

### é—®é¢˜2ï¼šåŠ å…¥æˆ¿é—´å¤±è´¥

**é”™è¯¯ä¿¡æ¯**ï¼š`Room "abc123" not found`

**åŸå› **ï¼š
- æˆ¿é—´IDè¾“å…¥é”™è¯¯ï¼ˆåŒºåˆ†å¤§å°å†™ï¼‰
- æˆ¿é—´å·²æ»¡å‘˜
- æˆ¿é—´å·²å…³é—­

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. ä»”ç»†æ ¸å¯¹æˆ¿é—´IDï¼ˆå»ºè®®å¤åˆ¶ç²˜è´´ï¼‰
2. è®¿é—® `http://localhost:2567/rooms` æŸ¥çœ‹å¯ç”¨æˆ¿é—´
3. åˆ›å»ºæ–°æˆ¿é—´

---

### é—®é¢˜3ï¼šçœ‹ä¸åˆ°è¿œç¨‹ç©å®¶

**æ£€æŸ¥æ¸…å•**ï¼š
1. âœ… RemotePlayerManageræ˜¯å¦æ­£ç¡®é…ç½®ï¼Ÿ
   - `remotePlayerPrefab` æ˜¯å¦å·²è®¾ç½®
   - Consoleæ˜¯å¦æ˜¾ç¤º"åˆ›å»ºè¿œç¨‹ç©å®¶æˆåŠŸ"

2. âœ… è¿œç¨‹ç©å®¶é¢„åˆ¶ä½“æ˜¯å¦æ­£ç¡®ï¼Ÿ
   - é¢„åˆ¶ä½“ä¸­æ˜¯å¦æœ‰å¯è§çš„æ¨¡å‹
   - æ˜¯å¦æ·»åŠ äº†RemotePlayerControllerç»„ä»¶

3. âœ… æ£€æŸ¥ç©å®¶ä½ç½®
   - è¿œç¨‹ç©å®¶å¯èƒ½åœ¨è§†é‡å¤–
   - æŸ¥çœ‹Sceneè§†å›¾ä¸­æ˜¯å¦æœ‰è¿œç¨‹ç©å®¶èŠ‚ç‚¹

---

### é—®é¢˜4ï¼šè¿œç¨‹ç©å®¶ä¸ä¼šç§»åŠ¨

**æ£€æŸ¥æ¸…å•**ï¼š
1. âœ… PlayerSyncControlleræ˜¯å¦æ­£ç¡®æŒ‚è½½åœ¨æœ¬åœ°ç©å®¶ä¸Šï¼Ÿ
2. âœ… æ£€æŸ¥Consoleæ˜¯å¦æœ‰åŒæ­¥æ—¥å¿—ï¼š
   ```
   [PlayerSyncController] åŒæ­¥çŠ¶æ€: pos(...), moving(true)
   ```
3. âœ… RemotePlayerControllerçš„enableSmoothingæ˜¯å¦å‹¾é€‰ï¼Ÿ
4. âœ… æ£€æŸ¥æœåŠ¡å™¨Consoleæ˜¯å¦æ”¶åˆ°playerMoveæ¶ˆæ¯

**è°ƒè¯•æ–¹æ³•**ï¼š
```typescript
// åœ¨RemotePlayerController.tsçš„updatePlayerStateæ–¹æ³•ä¸­æ·»åŠ ï¼š
console.log(`æ›´æ–°è¿œç¨‹ç©å®¶ä½ç½®: (${playerData.x}, ${playerData.y}, ${playerData.z})`);
```

---

### é—®é¢˜5ï¼šColyseusæœªå®šä¹‰

**é”™è¯¯ä¿¡æ¯**ï¼š`ReferenceError: Colyseus is not defined`

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥ `colyseus.js` æ˜¯å¦åœ¨ `assets/libs/` ç›®å½•
2. æ£€æŸ¥ `colyseus.js` æ˜¯å¦å‹¾é€‰"ä½œä¸ºæ’ä»¶å¯¼å…¥"
3. åœ¨ `NetworkManager.ts` é¡¶éƒ¨æ·»åŠ ï¼š
   ```typescript
   declare const Colyseus: any;
   ```
4. é‡å¯Cocos Creator

---

### é—®é¢˜6ï¼šåœºæ™¯åˆ‡æ¢åæ–­å¼€è¿æ¥

**åŸå› **ï¼šNetworkManageræ²¡æœ‰æŒä¹…åŒ–

**è§£å†³æ–¹æ¡ˆ**ï¼š
å·²åœ¨NetworkManagerä¸­å®ç°äº†æŒä¹…åŒ–ï¼š
```typescript
onLoad() {
    // è®¾ç½®ä¸ºå¸¸é©»èŠ‚ç‚¹ï¼ˆè·¨åœºæ™¯ä¿ç•™ï¼‰
    director.addPersistRootNode(this.node);
}
```

**éªŒè¯**ï¼š
- ä»LobbySceneåˆ‡æ¢åˆ°GameScene
- Consoleä¸åº”è¯¥å‡ºç°"è¿æ¥æ–­å¼€"
- NetworkManagerèŠ‚ç‚¹åº”è¯¥ä¿ç•™åœ¨å±‚çº§é¢æ¿ä¸­

---

## 9. æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 9.1 è°ƒæ•´åŒæ­¥é¢‘ç‡

**æ ¹æ®å®é™…ç½‘ç»œæƒ…å†µè°ƒæ•´**ï¼š

```typescript
// PlayerSyncControllerç»„ä»¶
syncInterval: 0.05  // é»˜è®¤20æ¬¡/ç§’

// å¦‚æœç½‘ç»œå»¶è¿Ÿé«˜ï¼Œå¯ä»¥é™ä½é¢‘ç‡ï¼š
syncInterval: 0.1   // 10æ¬¡/ç§’
```

---

### 9.2 å¯ç”¨å¯¹è±¡æ± 

**ä¼˜åŒ–è¿œç¨‹ç©å®¶çš„åˆ›å»º/é”€æ¯**ï¼š

```typescript
// åœ¨RemotePlayerManagerä¸­å®ç°å¯¹è±¡æ± 
private _playerPool: Node[] = [];

private getPlayerFromPool(): Node {
    if (this._playerPool.length > 0) {
        return this._playerPool.pop()!;
    }
    return instantiate(this.remotePlayerPrefab!);
}

private returnPlayerToPool(node: Node) {
    node.active = false;
    this._playerPool.push(node);
}
```

---

### 9.3 å‡å°‘æ—¥å¿—è¾“å‡º

**ç”Ÿäº§ç¯å¢ƒå…³é—­è°ƒè¯•æ—¥å¿—**ï¼š

- NetworkManager: `enableDebugLog = false`
- RemotePlayerManager: `enableDebugLog = false`
- PlayerSyncController: `enableDebugLog = false`
- RemotePlayerController: `showDebugInfo = false`

---

## 10. ä¸‹ä¸€æ­¥

å®¢æˆ·ç«¯é…ç½®å®Œæˆåï¼š
1. âœ… å‚è§ã€Šä»»åŠ¡4.1_æœåŠ¡å™¨éƒ¨ç½²æŒ‡å—.mdã€‹å¯åŠ¨æœåŠ¡å™¨
2. âœ… å‚è§ã€Šä»»åŠ¡4.1_è”æœºæµ‹è¯•æŒ‡å—.mdã€‹è¿›è¡Œå®Œæ•´æµ‹è¯•
3. âœ… å¼€å§‹ã€ä»»åŠ¡4.2ã€‘ï¼šå®ç°æ¸¸æˆç©æ³•çš„ç½‘ç»œåŒæ­¥

---

**æ–‡æ¡£ç”Ÿæˆæ—¶é—´**ï¼š2025-10-03
**é€‚ç”¨ç‰ˆæœ¬**ï¼šCocos Creator 3.6.x+, Colyseus 0.15.x
**é…ç½®çŠ¶æ€**ï¼šâœ… å®¢æˆ·ç«¯é…ç½®å°±ç»ª
