# 任务3.1：Cocos Creator配置步骤指南

## 📋 配置概览

本文档详细说明如何在Cocos Creator编辑器中配置角色模型和动画系统。

**前置条件：**
- 已将逃生者和追捕者FBX模型导入到项目资源文件夹
- 模型包含动画剪辑（逃生者：idle、run；追捕者：idle、run、attack）

---

## 🎯 第一部分：模型资源导入与配置

### 步骤1：导入FBX模型

1. 在Cocos Creator中，打开 **资源管理器（Assets）**
2. 在 `assets/` 目录下创建文件夹结构：
   ```
   assets/
   ├── models/
   │   ├── survivor/        # 逃生者模型文件夹
   │   │   └── survivor.fbx
   │   └── hunter/          # 追捕者模型文件夹
   │       └── hunter.fbx
   ```
3. 将FBX文件拖拽到对应文件夹中

### 步骤2：配置模型导入选项

**对于每个FBX文件：**

1. 在资源管理器中**选中FBX文件**
2. 在 **属性检查器（Inspector）** 中查看导入设置
3. 确认以下设置：
   - ✅ **导入网格（Import Mesh）**：勾选
   - ✅ **导入骨骼（Import Skeleton）**：勾选（如果有骨骼动画）
   - ✅ **导入动画（Import Animation）**：勾选
   - ✅ **拆分动画剪辑（Split Animation Clips）**：勾选（如果FBX包含多个动画）

4. 点击 **应用（Apply）** 按钮保存设置

### 步骤3：提取动画剪辑

**方法A：自动拆分（推荐）**

如果FBX文件已经包含命名好的动画片段：

1. 选中FBX文件
2. 在属性检查器中找到 **动画剪辑列表（Animation Clips）**
3. 点击 **刷新（Refresh）** 按钮
4. 确认看到所有动画剪辑：
   - 逃生者：`idle`、`run`
   - 追捕者：`idle`、`run`、`attack`

**方法B：手动拆分**

如果需要手动定义动画片段：

1. 选中FBX文件
2. 在属性检查器中找到 **动画剪辑列表**
3. 点击 **添加（Add）** 按钮
4. 为每个动画设置：
   - **名称（Name）**：如 `idle`、`run`、`attack`
   - **起始帧（Start Frame）**：动画起始帧号
   - **结束帧（End Frame）**：动画结束帧号
   - **是否循环（Loop）**：
     - idle：✅ 勾选
     - run：✅ 勾选
     - attack：❌ 不勾选（单次播放）

5. 点击 **应用（Apply）**

---

## 🎮 第二部分：场景配置

### 步骤4：替换逃生者模型（Survivor）

#### 4.1 创建模型节点

1. 在 **层级管理器（Hierarchy）** 中找到现有的逃生者节点（如`Capsule`或`Survivor`）
2. 在该节点下创建子节点：
   - 右键点击逃生者节点
   - 选择 **创建 → 空节点（Create Empty Node）**
   - 命名为 `Model`

#### 4.2 添加模型

1. 从资源管理器中找到 `survivor.fbx`
2. **拖拽FBX文件**到刚创建的`Model`节点上
3. Cocos Creator会自动创建模型实例

#### 4.3 调整模型Transform

在属性检查器中调整Model节点的Transform：

```
Position: (0, 0, 0)      # 相对于父节点
Rotation: (0, 0, 0)      # 朝向（可能需要旋转Y轴180度）
Scale: (1, 1, 1)         # 根据实际大小调整
```

**重要提示：**
- 模型的方向应该与原始Capsule一致（通常是朝向Z轴负方向）
- 如果模型朝向不对，调整Rotation的Y值（如180度）

#### 4.4 添加Animation组件

1. 选中 `Model` 节点（或包含骨骼的根节点）
2. 在属性检查器中点击 **添加组件（Add Component）**
3. 选择 **Animation（动画组件）**
4. 在Animation组件中：
   - **Default Clip**：设置为 `idle` 动画剪辑
   - **Play On Load**：✅ 勾选（启动时自动播放）

#### 4.5 添加CharacterAnimationController组件

1. 选中 `Model` 节点
2. 点击 **添加组件 → 自定义脚本 → CharacterAnimationController**
3. 配置参数：

```typescript
Animation Component: [拖拽Model节点的Animation组件]
Idle Clip: [从资源管理器拖拽 idle 动画剪辑]
Run Clip: [从资源管理器拖拽 run 动画剪辑]
Attack Clip: [留空，逃生者不需要]
Character Type: SURVIVOR
Cross Fade Duration: 0.2
Auto Find Animation: ✅ 勾选
```

**如何找到动画剪辑：**
1. 在资源管理器中展开 `survivor.fbx`
2. 会看到子资源（动画剪辑）
3. 将对应的剪辑拖拽到CharacterAnimationController的属性框中

#### 4.6 绑定动画控制器到PlayerController

1. 选中逃生者根节点（包含PlayerController的节点）
2. 找到 **PlayerController** 组件
3. 将 `Model` 节点拖拽到 **Animation Controller** 属性框中

#### 4.7 隐藏或删除原始Capsule

1. 找到原始的Capsule模型节点
2. 取消勾选 **Active** 复选框（隐藏）
3. 或者直接删除Capsule节点（如果不需要了）

---

### 步骤5：替换追捕者模型（Hunter）

重复步骤4的所有操作，但注意以下差异：

#### 5.1 CharacterAnimationController配置差异

```typescript
Animation Component: [拖拽Model节点的Animation组件]
Idle Clip: [从资源管理器拖拽 idle 动画剪辑]
Run Clip: [从资源管理器拖拽 run 动画剪辑]
Attack Clip: [从资源管理器拖拽 attack 动画剪辑]  ← ✅ 追捕者需要
Character Type: HUNTER  ← ✅ 选择HUNTER
Cross Fade Duration: 0.2
Attack Animation Duration: 1.0  # 根据实际attack动画长度设置
Auto Find Animation: ✅ 勾选
```

#### 5.2 绑定到HunterController

1. 选中追捕者根节点（包含HunterController的节点）
2. 找到 **HunterController** 组件
3. 将 `Model` 节点拖拽到 **Animation Controller** 属性框中

---

## 🔧 第三部分：高级配置（可选）

### 选项1：使用动画状态机（Animation Graph）

如果你的动画更复杂，可以使用Cocos Creator的Animation Graph：

1. 在资源管理器中创建 **Animation Graph** 资源
2. 双击打开Animation Graph编辑器
3. 创建状态节点：
   - Idle状态
   - Run状态
   - Attack状态（追捕者）
4. 创建转换条件：
   - Idle → Run：条件 `isMoving = true`
   - Run → Idle：条件 `isMoving = false`
   - 任意状态 → Attack：条件 `triggerAttack()`

**注意：** 当前实现使用代码控制，更简单直接。Animation Graph适合更复杂的多状态转换需求。

---

### 选项2：调整动画过渡效果

如果动画切换不够平滑：

1. 调整 **Cross Fade Duration**（交叉淡入淡出时长）
   - 默认：0.2秒
   - 快速切换：0.1秒
   - 平滑切换：0.3-0.5秒

2. 检查动画剪辑的循环设置：
   - idle和run应该勾选 **Loop（循环）**
   - attack不应该循环

---

### 选项3：同步动画速度与移动速度

如果角色移动速度与跑步动画不匹配（滑步或踏步）：

**方法A：调整动画播放速度**

1. 在CharacterAnimationController中添加参数：
```typescript
@property
public runAnimationSpeed: number = 1.0; // 跑步动画播放速度倍数
```

2. 修改代码，在播放动画时设置速度：
```typescript
if (this.animationComponent) {
    const state = this.animationComponent.getState(this.runClip.name);
    if (state) {
        state.speed = this.runAnimationSpeed;
    }
    this.animationComponent.crossFade(this.runClip.name, this.crossFadeDuration);
}
```

**方法B：调整角色移动速度**

修改PlayerController或HunterController的 `moveSpeed` 参数，使其与动画速度匹配。

---

## ✅ 第四部分：验证与测试

### 测试清单

#### 逃生者动画测试

1. **静止时：**
   - [ ] 播放idle动画
   - [ ] 动画循环正常
   - [ ] 无卡顿或跳帧

2. **移动时：**
   - [ ] 按下摇杆，立即切换到run动画
   - [ ] 动画过渡平滑（无突兀跳变）
   - [ ] 跑步动画循环正常
   - [ ] 移动速度与动画速度匹配（无滑步）

3. **停止移动：**
   - [ ] 松开摇杆，立即切换回idle动画
   - [ ] 动画过渡平滑

#### 追捕者动画测试

1. **静止时：**
   - [ ] 播放idle动画

2. **移动时：**
   - [ ] 播放run动画
   - [ ] 移动速度115%明显快于逃生者

3. **攻击时：**
   - [ ] 点击攻击按钮，播放attack动画
   - [ ] 攻击动画播放完整（不被打断）
   - [ ] 攻击动画结束后自动切换回idle
   - [ ] 攻击中无法切换到run动画

---

## 🐛 常见问题排查

### 问题1：动画不播放

**可能原因：**
- Animation组件未正确绑定
- 动画剪辑未正确拖拽
- Animation组件在错误的节点上

**解决方案：**
1. 检查Animation组件是否在包含骨骼的节点上
2. 检查Default Clip是否设置为idle
3. 检查Play On Load是否勾选
4. 查看控制台是否有错误信息

---

### 问题2：动画切换突兀

**可能原因：**
- Cross Fade Duration设置为0
- 动画剪辑的起止帧不连续

**解决方案：**
1. 将Cross Fade Duration设置为0.2-0.3秒
2. 检查动画剪辑的起止帧设置
3. 确保动画循环点平滑

---

### 问题3：攻击动画播放后不恢复

**可能原因：**
- Attack Animation Duration设置错误
- 动画剪辑实际长度与设置不符

**解决方案：**
1. 播放attack动画，用秒表计时
2. 将测得的时间设置到Attack Animation Duration
3. 或在动画剪辑属性中查看总帧数和帧率，计算时长：
   ```
   时长 = 总帧数 / 帧率
   例如：30帧 / 30fps = 1.0秒
   ```

---

### 问题4：模型朝向错误

**可能原因：**
- FBX导出时坐标系不匹配
- 模型在建模软件中的朝向与Cocos不一致

**解决方案：**
1. 调整Model节点的Rotation Y值：
   - 试试0度、90度、180度、270度
2. 或在建模软件中重新导出，调整坐标系设置

---

### 问题5：模型太大或太小

**解决方案：**
1. 调整Model节点的Scale值（统一缩放）
2. 或在建模软件中重新导出，调整单位比例

---

### 问题6：控制台报错"动画剪辑未绑定"

**错误信息：**
```
[CharacterAnimationController] idle动画剪辑未绑定！
```

**解决方案：**
1. 检查CharacterAnimationController的Idle Clip属性
2. 确认已从资源管理器拖拽动画剪辑到该属性
3. 确认动画剪辑名称与FBX中的名称一致

---

## 📸 配置截图参考

### 图1：资源管理器结构示例

```
assets/
├── models/
│   ├── survivor/
│   │   ├── survivor.fbx
│   │   ├── idle (AnimationClip)
│   │   └── run (AnimationClip)
│   └── hunter/
│       ├── hunter.fbx
│       ├── idle (AnimationClip)
│       ├── run (AnimationClip)
│       └── attack (AnimationClip)
└── scripts/
    ├── CharacterAnimationController.ts
    ├── PlayerController.ts
    └── HunterController.ts
```

### 图2：层级结构示例

```
Scene/
├── Survivor (PlayerController, CharacterState)
│   ├── Model (Animation, CharacterAnimationController)
│   │   └── [骨骼和网格节点]
│   └── [其他子节点...]
└── Hunter (HunterController, Hunter)
    ├── Model (Animation, CharacterAnimationController)
    │   └── [骨骼和网格节点]
    └── [其他子节点...]
```

### 图3：CharacterAnimationController配置示例

**逃生者：**
```
┌─────────────────────────────────────┐
│ CharacterAnimationController        │
├─────────────────────────────────────┤
│ Animation Component: [Model]        │
│ Idle Clip: [idle]                   │
│ Run Clip: [run]                     │
│ Attack Clip: [None]                 │
│ Character Type: SURVIVOR ▼          │
│ Cross Fade Duration: 0.2            │
│ Auto Find Animation: ✓              │
└─────────────────────────────────────┘
```

**追捕者：**
```
┌─────────────────────────────────────┐
│ CharacterAnimationController        │
├─────────────────────────────────────┤
│ Animation Component: [Model]        │
│ Idle Clip: [idle]                   │
│ Run Clip: [run]                     │
│ Attack Clip: [attack]               │
│ Character Type: HUNTER ▼            │
│ Cross Fade Duration: 0.2            │
│ Attack Animation Duration: 1.0      │
│ Auto Find Animation: ✓              │
└─────────────────────────────────────┘
```

---

## 🚀 快速配置检查表

完成配置后，按照此清单逐项检查：

### 逃生者配置
- [ ] FBX文件已导入到 `assets/models/survivor/`
- [ ] 动画剪辑 idle 和 run 已正确提取
- [ ] 创建了Model子节点
- [ ] Model节点添加了Animation组件
- [ ] Model节点添加了CharacterAnimationController组件
- [ ] 所有动画剪辑已拖拽到CharacterAnimationController
- [ ] Character Type设置为SURVIVOR
- [ ] PlayerController的Animation Controller已绑定Model节点
- [ ] 原始Capsule已隐藏或删除

### 追捕者配置
- [ ] FBX文件已导入到 `assets/models/hunter/`
- [ ] 动画剪辑 idle、run、attack 已正确提取
- [ ] 创建了Model子节点
- [ ] Model节点添加了Animation组件
- [ ] Model节点添加了CharacterAnimationController组件
- [ ] 所有动画剪辑已拖拽到CharacterAnimationController
- [ ] Character Type设置为HUNTER
- [ ] Attack Animation Duration已根据实际动画长度设置
- [ ] HunterController的Animation Controller已绑定Model节点
- [ ] 原始红色Cube已隐藏或删除

### 最终测试
- [ ] 运行游戏，逃生者静止时播放idle
- [ ] 移动逃生者，播放run动画
- [ ] 移动追捕者，播放run动画
- [ ] 追捕者攻击时播放attack动画
- [ ] 所有动画切换平滑无卡顿

---

## 📚 补充资料

### Cocos Creator动画系统官方文档

- [动画组件](https://docs.cocos.com/creator/3.x/manual/zh/animation/animation-component.html)
- [动画剪辑](https://docs.cocos.com/creator/3.x/manual/zh/animation/animation-clip.html)
- [导入模型资源](https://docs.cocos.com/creator/3.x/manual/zh/asset/model/mesh.html)

### 推荐工具

- **Blender**：免费3D建模软件，可用于调整模型朝向和比例
- **FBX Review**（Autodesk）：免费FBX文件查看工具，可预览动画

---

**配置完成！现在可以开始测试任务3.1的动画系统了。** 🎉
