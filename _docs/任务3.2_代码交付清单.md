# 任务3.2：实现核心UI界面(HUD) - 代码交付清单

## 📋 任务概述
- **任务名称**：实现核心UI界面(HUD)
- **开发阶段**：第三阶段
- **完成日期**：2025-10-02
- **版本号**：V3.2

---

## 📦 新增文件清单

### 1. UIManager.ts
**文件路径**：`CocosProject/assets/scripts/UIManager.ts`
**文件大小**：约310行
**功能说明**：
- HUD核心UI管理器
- 管理倒计时、矿石进度、团队成员状态等UI元素
- 与GameManager和CharacterState实时同步
- 自动查找场景中的逃生者并绑定UI

**核心功能**：
```typescript
// 主要方法
public refreshUI(): void                           // 手动刷新所有UI
public getTeamMemberCount(): number                // 获取团队成员数量
public getTeamMemberState(index: number): CharacterStateType | null // 获取成员状态
public debugPrintTeamStatus(): void                // 调试打印团队状态

// 内部方法
private initializeTeamMemberUI(): void             // 初始化团队UI
private onCharacterStateChange(): void             // 角色状态变化回调
private updateTeamMemberColor(): void              // 更新团队成员颜色
private onStatsChange(): void                      // GameManager统计变化回调
private updateTimerDisplay(): void                 // 更新倒计时显示
private updateOreProgressDisplay(): void           // 更新矿石进度显示
```

**Editor配置属性**：
| 属性名 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| timerLabel | Label | null | 倒计时显示Label（必需） |
| oreProgressLabel | Label | null | 矿石进度显示Label（必需） |
| teamStatusContainer | Node | null | 团队状态容器（可选） |
| teamMemberSprites | Sprite[] | [] | 4个团队成员状态方块（必需） |
| autoFindTeamMembers | boolean | true | 自动查找逃生者 |
| normalColor | Color | (0,255,0,255) | 正常状态颜色-绿色 |
| caughtColor | Color | (255,165,0,255) | 被抓状态颜色-橙色 |
| hangedColor | Color | (255,0,0,255) | 被挂起状态颜色-红色 |
| eliminatedColor | Color | (128,128,128,255) | 淘汰状态颜色-灰色 |
| enableDebugLog | boolean | false | 启用调试日志 |

**数据同步机制**：
- 每帧更新倒计时显示（`update()`方法）
- 通过GameManager的`onStatsChange`回调更新矿石进度
- 通过CharacterState的`onStateChange`回调更新团队成员颜色

**特色功能**：
- ✅ 自动查找场景中命名包含"Survivor"的逃生者节点
- ✅ 倒计时 < 60秒时文字变红色警告
- ✅ 矿石收集完成时文字变绿色提示
- ✅ 支持调试模式（Console输出详细日志）

---

### 2. TeamStatusUI.ts
**文件路径**：`CocosProject/assets/scripts/TeamStatusUI.ts`
**文件大小**：约170行
**功能说明**：
- 单个团队成员状态UI组件
- 可复用的团队成员状态方块
- 支持显示成员编号和状态文字（可选）

**核心接口**：
```typescript
// 公共方法
public bindCharacter(characterState: CharacterState, index: number): void // 绑定角色
public getCurrentState(): CharacterStateType | null  // 获取当前状态
public getMemberIndex(): number                      // 获取成员索引
public getCharacterNode(): Node | null               // 获取绑定的角色节点
public refresh(): void                               // 手动刷新显示

// 内部方法
private onStateChange(oldState, newState): void      // 状态变化回调
private updateDisplay(): void                        // 更新显示
private updateColor(state): void                     // 更新颜色
private updateStateText(state): void                 // 更新状态文字
```

**Editor配置属性**：
| 属性名 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| statusSprite | Sprite | null | 状态方块（必需） |
| memberIndexLabel | Label | null | 成员编号Label（可选） |
| stateTextLabel | Label | null | 状态文字Label（可选） |
| normalColor | Color | (0,255,0,255) | 正常状态颜色 |
| caughtColor | Color | (255,165,0,255) | 被抓状态颜色 |
| hangedColor | Color | (255,0,0,255) | 被挂起状态颜色 |
| eliminatedColor | Color | (128,128,128,255) | 淘汰状态颜色 |
| showStateText | boolean | false | 是否显示状态文字 |

**使用场景**：
- 当前任务使用UIManager直接管理4个Sprite
- 后续任务可使用TeamStatusUI创建更复杂的团队成员UI（带头像、血量、技能图标等）

**扩展性**：
- 可添加成员头像（Sprite）
- 可添加生命值显示（Label/ProgressBar）
- 可添加角色名称（Label）
- 可添加状态图标（Sprite）

---

## 🔧 修改文件清单

### 3. GameManager.ts (V2.2 → V3.2)
**文件路径**：`CocosProject/assets/scripts/GameManager.ts`
**修改内容**：新增UI查询接口

**新增方法**：
```typescript
/**
 * 获取生成逃生门所需矿石数量（任务3.2新增）
 */
public getOresRequiredForExit(): number {
    return this.oresRequiredForExit;
}
```

**修改位置**：第385-390行

**新增代码**：+6行

**修改原因**：
UIManager需要获取`oresRequiredForExit`来显示矿石进度格式`x/8`

**影响范围**：
- ✅ 不影响现有功能
- ✅ 仅添加查询接口，无副作用
- ✅ 完全向后兼容

---

## 📄 配置文档清单

### 4. 任务3.2_Cocos Creator UI搭建步骤.md
**文件路径**：`_docs/任务3.2_Cocos Creator UI搭建步骤.md`
**文件大小**：约1200行
**内容结构**：

#### 章节1：UI层级结构总览
- 完整的UI层级树状图
- 节点命名规范

#### 章节2：创建Canvas根节点
- Canvas创建步骤（3个步骤）
- Canvas配置参数（Design Resolution、Fit模式）
- UITransform配置

#### 章节3：搭建左上角团队成员状态UI
- 创建TeamStatusPanel容器
- 配置锚点和位置（Left-Top）
- 创建4个团队成员状态方块（详细步骤）
- 使用内置白色方块作为SpriteFrame
- 水平排列配置

#### 章节4：搭建正上方倒计时UI
- 创建TopPanel容器
- 配置锚点和位置（Top-Center）
- 创建TimerLabel
- Label参数配置（字体大小、对齐方式、颜色）
- 自定义字体使用方法

#### 章节5：搭建正上方矿石进度UI
- 创建OreProgressLabel
- 位置配置（位于倒计时下方）
- Label参数配置

#### 章节6：绑定UIManager脚本
- 添加UIManager组件到Canvas
- 绑定倒计时Label（6个步骤）
- 绑定矿石进度Label
- 绑定团队成员Sprite数组（重点：如何拖拽Sprite组件）
- 配置自动查找和调试选项

#### 章节7：测试与调试
- 检查逃生者节点命名
- 检查CharacterState组件
- 检查GameManager节点
- 运行测试步骤（4个子步骤）
- 动态更新测试（倒计时、矿石进度、团队状态）

#### 章节8：常见问题排查
- 问题1：团队成员状态方块没有显示
- 问题2：倒计时或矿石进度不更新
- 问题3：团队成员状态方块颜色不变化
- 问题4：UI元素位置错误或看不见
- 问题5：拖拽节点到属性框时无法绑定
- 问题6：Console显示"已存在实例，销毁当前节点"
- 问题7：方块颜色始终是绿色

每个问题包含：
- 可能原因分析
- 详细解决方案
- 调试方法
- 测试代码（如适用）

#### 附录：配置检查清单
- Canvas层级结构检查（4项）
- UIManager组件配置检查（7项）
- 场景配置检查（4项）
- 运行测试检查（5项）

#### 附录：UI美化建议
- 添加背景面板
- 添加图标
- 使用自定义字体

---

## 📊 代码统计

| 项目 | 数量 |
|------|------|
| 新增脚本 | 2个 |
| 修改脚本 | 1个 |
| 新增代码行数 | ~480行 |
| 修改代码行数 | +6行 |
| 新增文档 | 2个 |
| 文档总字数 | ~3200字 |
| UI节点数量 | 9个 |
| UI组件数量 | 8个 |

---

## 🔗 依赖关系图

```
UIManager.ts (新增)
    ↓ 依赖
    ├── GameManager.ts (修改)
    │   └── 调用 getStats(), getTimeRemaining(), getOresRequiredForExit()
    │
    └── CharacterState.ts (无修改)
        └── 注册 onStateChange() 回调

TeamStatusUI.ts (新增，可选使用)
    ↓ 依赖
    └── CharacterState.ts (无修改)
        └── 注册 onStateChange() 回调

UI节点层级：
Canvas
├── UIManager组件
├── TopPanel
│   ├── TimerLabel (Label)
│   └── OreProgressLabel (Label)
└── TeamStatusPanel
    ├── TeamMember1 (Sprite)
    ├── TeamMember2 (Sprite)
    ├── TeamMember3 (Sprite)
    └── TeamMember4 (Sprite)
```

---

## 📌 配置要点提醒

### ⚠️ 必需配置项

**UIManager组件配置**：
1. **Timer Label**：必须绑定TimerLabel节点的Label组件
2. **Ore Progress Label**：必须绑定OreProgressLabel节点的Label组件
3. **Team Member Sprites数组**：
   - Size必须设置为4
   - 每个元素必须绑定对应TeamMember节点的**Sprite组件**（不是Node！）
4. **Auto Find Team Members**：建议勾选（自动查找逃生者）

**场景配置**：
1. 场景中必须有4个逃生者节点
2. 逃生者节点命名必须包含"Survivor"关键词（如：Survivor1, Survivor2...）
3. 每个逃生者节点必须挂载CharacterState组件
4. 场景中必须有GameManager节点

### 💡 推荐配置项

**调试选项**：
- 开发阶段建议勾选`Enable Debug Log`
- 发布版本取消勾选以提升性能

**颜色配置**：
- 使用默认颜色即可（绿/橙/红/灰）
- 如需自定义，确保颜色区分度高

**Canvas配置**：
- Design Resolution推荐`1920 x 1080`
- Fit Height和Fit Width都勾选，适配不同屏幕

### ⚡ 常见错误避免

**❌ 错误1**：将Node拖拽到Team Member Sprites数组
- ✅ 正确做法：拖拽Node后，在弹出菜单中选择"Sprite"组件

**❌ 错误2**：逃生者节点命名为"Player1"、"Character1"等
- ✅ 正确做法：命名为"Survivor1"、"Survivor2"等（包含"Survivor"关键词）

**❌ 错误3**：忘记给逃生者添加CharacterState组件
- ✅ 正确做法：每个逃生者节点都必须挂载CharacterState组件

**❌ 错误4**：Team Member Sprites数组Size为0或不足4
- ✅ 正确做法：Size必须设置为4，对应4个逃生者

---

## 🧪 测试验证清单

### ✅ UI显示测试
- [ ] 左上角显示4个绿色方块（初始状态）
- [ ] 正上方显示倒计时`05:00`
- [ ] 倒计时下方显示矿石进度`0/8`
- [ ] UI元素位置正确，不遮挡游戏画面
- [ ] UI元素大小合适，可清晰阅读

### ✅ 倒计时功能测试
- [ ] 游戏开始后倒计时每秒递减（05:00 → 04:59 → ...）
- [ ] 倒计时 < 60秒时文字变红色
- [ ] 倒计时到0:00时游戏结束

### ✅ 矿石进度功能测试
- [ ] 初始显示`0/8`
- [ ] 拾取矿石后实时更新（0/8 → 1/8 → 2/8 → ...）
- [ ] 达到`8/8`时文字变绿色
- [ ] 达到8个后逃生门生成

### ✅ 团队成员状态功能测试
- [ ] 初始4个方块都是绿色（正常状态）
- [ ] 逃生者被抓后，对应方块变橙色
- [ ] 逃生者被挂起后，对应方块变红色
- [ ] 逃生者被淘汰后，对应方块变灰色
- [ ] 逃生者被救援后，对应方块恢复绿色

### ✅ 性能测试
- [ ] 运行游戏帧率正常（>30fps）
- [ ] Console无错误信息
- [ ] UI更新流畅，无卡顿

### ✅ 兼容性测试
- [ ] 不同分辨率下UI显示正常
- [ ] UI元素不遮挡重要游戏内容
- [ ] UI元素在安全区域内（不被刘海屏遮挡）

---

## 📈 功能完成度

| 功能模块 | 完成度 | 说明 |
|---------|--------|------|
| 倒计时UI | ✅ 100% | 实时更新，<60s变红警告 |
| 矿石进度UI | ✅ 100% | 实时更新，完成时变绿提示 |
| 团队成员状态UI | ✅ 100% | 4种状态颜色，自动同步 |
| 自动查找逃生者 | ✅ 100% | 自动绑定场景中的Survivor节点 |
| 数据同步机制 | ✅ 100% | 通过回调实时同步GameManager和CharacterState |
| 调试功能 | ✅ 100% | Console日志输出，手动刷新UI |
| 配置文档 | ✅ 100% | 详细步骤，8个常见问题排查 |

**总体完成度**：✅ **100%**

---

## 🎯 与GDD需求对比

| GDD需求 | 实现状态 | 说明 |
|---------|---------|------|
| 左上角：团队成员状态显示（4个小方块） | ✅ 已实现 | 4个Sprite，颜色表示状态 |
| 正上方：游戏倒计时（格式05:00） | ✅ 已实现 | Label显示，MM:SS格式 |
| 正上方：矿石收集进度（格式0/8） | ✅ 已实现 | Label显示，x/8格式 |
| 倒计时与GameManager实时同步 | ✅ 已实现 | 每帧更新，通过getTimeRemaining() |
| 矿石进度与GameManager实时同步 | ✅ 已实现 | 通过onStatsChange回调更新 |
| 团队成员状态与CharacterState同步 | ✅ 已实现 | 通过onStateChange回调更新 |
| 不同颜色表示状态（绿/红/灰） | ✅ 已实现 | 绿-正常，橙-被抓，红-挂起，灰-淘汰 |

**符合度**：✅ **100%**

---

## 🚀 下一步建议

### 立即可做
1. 按照配置文档在Cocos Creator中搭建UI层级
2. 绑定UIManager组件到Canvas
3. 运行游戏测试UI显示和数据同步

### 后续优化
1. 添加UI动画效果：
   - 倒计时 < 10秒时闪烁动画
   - 矿石进度更新时数字跳动
   - 团队成员状态变化时颜色渐变
2. 添加更多UI元素：
   - 逃脱人数显示
   - 淘汰人数显示
   - 游戏结果面板（已有GameUI.ts，可复用）
3. 添加UI音效：
   - 倒计时滴答声
   - 矿石拾取提示音
   - 队友被抓警告音
4. 优化UI布局：
   - 添加半透明背景面板
   - 添加图标和装饰元素
   - 使用自定义字体

### 扩展功能
1. 使用TeamStatusUI替代简单Sprite：
   - 显示成员编号（1、2、3、4）
   - 显示成员头像
   - 显示成员状态文字（"正常"、"被抓"等）
2. 添加小地图UI（显示角色位置和逃生门）
3. 添加技能冷却UI（如果后续添加技能系统）

---

## 📧 技术支持

如配置过程中遇到问题，请参考：
1. `任务3.2_Cocos Creator UI搭建步骤.md` 的常见问题排查章节
2. UIManager.ts 中的注释说明
3. 运行游戏后查看Console输出的调试日志

**关键调试命令**：
```typescript
// 在Cocos Creator Console中运行
const uiManager = cc.find('Canvas').getComponent('UIManager');
uiManager.debugPrintTeamStatus(); // 打印所有团队成员状态
uiManager.refreshUI(); // 手动刷新UI
```

---

**文档生成时间**：2025-10-02
**脚本版本**：V3.2
**引擎要求**：Cocos Creator 3.x
**测试状态**：✅ 代码审查通过，等待实机测试
