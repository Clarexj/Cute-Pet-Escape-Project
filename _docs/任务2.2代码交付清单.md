# 任务2.2代码交付清单

## 📦 交付概览

**任务名称：** 实现追捕者基础玩法与完整游戏胜负流程
**交付日期：** 2025年
**开发者：** Claude Code

---

## 📄 新增文件清单

### 1. HunterController.ts
**路径：** `assets/scripts/HunterController.ts`
**功能：** 追捕者可控移动 + 攻击 + 踩碎木板
**代码行数：** ~370行

**核心功能：**
- ✅ 虚拟摇杆控制移动（复用PlayerController逻辑）
- ✅ 移动速度115%（5.75 m/s）
- ✅ 攻击按钮（2米范围，1秒冷却）
- ✅ 踩碎木板（2.5米范围）
- ✅ 自动检测附近逃生者和木板
- ✅ 回调系统（目标变化通知）

**依赖关系：**
```
HunterController → Hunter（调用catchSurvivor）
HunterController → Board（调用breakBoard）
HunterController → Joystick（读取输入）
```

**关键接口：**
```typescript
triggerAttack(): void              // 触发攻击
triggerBreakBoard(): void          // 踩碎木板
getAttackTarget(): Node | null     // 获取攻击目标
canAttack(): boolean               // 是否可以攻击
getAttackCooldownProgress(): number // 获取冷却进度
onAttackTargetChange(callback)     // 注册攻击目标变化回调
onBoardTargetChange(callback)      // 注册木板目标变化回调
```

---

### 2. GameManager.ts
**路径：** `assets/scripts/GameManager.ts`
**功能：** 游戏状态管理 + 倒计时 + 胜负判定
**代码行数：** ~400行

**核心功能：**
- ✅ 5分钟倒计时（300秒）
- ✅ 实时统计：矿石、逃脱、淘汰
- ✅ 3种胜负判定：
  - 淘汰≥3人 → 追捕者胜利
  - 逃脱≥3人 → 逃生者胜利
  - 时间到且逃脱=2人 → 平局
- ✅ 单例模式
- ✅ 事件回调系统

**依赖关系：**
```
GameManager → CharacterState（监听状态变化）
GameManager ← Ore（矿石拾取通知）
GameManager ← ExitZone（逃脱通知）
```

**关键接口：**
```typescript
startGame(): void                  // 开始游戏
restartGame(): void                // 重新开始
onOreCollected(node): void         // 矿石拾取
onSurvivorEscaped(node): void      // 逃生者逃脱
getCurrentState(): GameState       // 获取游戏状态
getStats(): GameStats              // 获取统计数据
getTimeRemainingFormatted(): string // 格式化剩余时间
static getInstance(): GameManager  // 获取单例
```

**枚举定义：**
```typescript
enum GameState {
    WAITING = 'waiting',
    PLAYING = 'playing',
    HUNTER_WIN = 'hunter_win',
    SURVIVOR_WIN = 'survivor_win',
    DRAW = 'draw'
}
```

---

### 3. GameUI.ts
**路径：** `assets/scripts/GameUI.ts`
**功能：** 游戏UI显示 - 倒计时、统计、结局
**代码行数：** ~220行

**核心功能：**
- ✅ 倒计时显示（MM:SS格式）
- ✅ 矿石数量显示
- ✅ 逃脱人数显示（X/3）
- ✅ 淘汰人数显示（X/3）
- ✅ 游戏结束面板（3种颜色）
- ✅ 自动订阅GameManager事件

**UI绑定要求：**
```
timerLabel: Label         // 倒计时文字
oreLabel: Label           // 矿石统计
escapedLabel: Label       // 逃脱统计
eliminatedLabel: Label    // 淘汰统计
gameOverPanel: Node       // 结束面板
gameOverLabel: Label      // 结束文字
```

**颜色规则：**
- 时间<1分钟：红色
- 逃脱≥3人：绿色
- 淘汰≥3人：红色
- 追捕者胜利：红色
- 逃生者胜利：绿色
- 平局：黄色

---

### 4. HunterUI.ts
**路径：** `assets/scripts/HunterUI.ts`
**功能：** 追捕者UI - 攻击和踩碎木板按钮
**代码行数：** ~200行

**核心功能：**
- ✅ 攻击按钮（自动显示/隐藏）
- ✅ 踩碎木板按钮（自动显示/隐藏）
- ✅ 攻击冷却进度显示
- ✅ 按钮点击事件处理

**UI绑定要求：**
```
attackButton: Node           // 攻击按钮
attackLabel: Label           // 攻击文字
breakBoardButton: Node       // 踩碎木板按钮
breakBoardLabel: Label       // 踩碎木板文字
hunterController: HunterController // 控制器引用
```

**按钮状态：**
- 靠近逃生者：显示"攻击 [名称]"
- 攻击冷却中：显示"冷却中 X%"，按钮禁用
- 靠近倒下木板：显示"踩碎木板"
- 无目标：隐藏按钮

---

### 5. ExitZone.ts
**路径：** `assets/scripts/ExitZone.ts`
**功能：** 逃脱区域触发器
**代码行数：** ~110行

**核心功能：**
- ✅ 触发器碰撞检测
- ✅ 逃生者逃脱判定（仅NORMAL状态）
- ✅ 通知GameManager
- ✅ 防重复计数
- ✅ 可选矿石数量要求

**配置参数：**
```typescript
exitPrompt: string                 // 区域提示
requireOreCount: number            // 逃脱所需矿石（0=不需要）
destroySurvivorOnExit: boolean     // 是否销毁节点
```

**使用方法：**
1. 创建3D节点
2. 添加BoxCollider（IsTrigger=true）
3. 添加ExitZone组件
4. 放置在地图边缘

---

## 📝 修改文件清单

### 1. Ore.ts（V1.0 → V1.1）
**修改内容：** 添加GameManager统计通知

**新增代码：**
```typescript
// 第7行：新增import
import { GameManager } from './GameManager';

// 第55-59行：通知GameManager
const gameManager = GameManager.getInstance();
if (gameManager) {
    gameManager.onOreCollected(this.node);
}
```

**影响范围：** 矿石拾取时自动计数

---

## 🔧 依赖关系图

```
GameManager（核心管理）
    ↑
    ├─ Ore.ts（矿石拾取通知）
    ├─ ExitZone.ts（逃脱通知）
    └─ CharacterState.ts（淘汰监听）

GameUI（UI显示）
    ↓
GameManager（数据订阅）

HunterController（追捕者控制）
    ├─ Hunter.ts（抓捕逻辑）
    ├─ Board.ts（踩碎木板）
    └─ Joystick（输入）

HunterUI（追捕者UI）
    ↓
HunterController（按钮回调）
```

---

## 🎮 场景配置要求

### 必需节点清单

| 节点名称 | 组件 | 父节点 | 说明 |
|---------|------|--------|------|
| GameManager | GameManager | Scene | 游戏管理器 |
| Hunter | HunterController + Hunter | Scene | 追捕者 |
| GameUI | GameUI | Canvas | 游戏UI |
| HunterUI | HunterUI | Canvas | 追捕者UI |
| ExitZone | ExitZone + BoxCollider | Scene | 逃脱区域 |

### GameUI子节点结构

```
GameUI (Component: GameUI)
├─ TimerLabel (Component: Label)
├─ OreLabel (Component: Label)
├─ EscapedLabel (Component: Label)
├─ EliminatedLabel (Component: Label)
└─ GameOverPanel (Component: Sprite, Active: false)
    └─ GameOverLabel (Component: Label)
```

### HunterUI子节点结构

```
HunterUI (Component: HunterUI)
├─ AttackButton (Component: Button, Active: false)
│   └─ AttackLabel (Component: Label)
└─ BreakBoardButton (Component: Button, Active: false)
    └─ BreakBoardLabel (Component: Label)
```

---

## ⚙️ 配置参数参考

### GameManager配置

```typescript
gameDuration: 300.0           // 5分钟
survivorsToWin: 3             // 逃生者胜利人数
eliminationsToWin: 3          // 追捕者胜利人数
autoStartGame: true           // 自动开始
```

### HunterController配置

```typescript
moveSpeed: 5.75               // 115%速度
rotationSpeed: 10.0           // 旋转速度
attackRange: 2.0              // 攻击范围
attackCooldown: 1.0           // 攻击冷却
boardBreakRange: 2.5          // 踩碎木板范围
```

### ExitZone配置

```typescript
exitPrompt: "逃脱区域"
requireOreCount: 0            // 不需要矿石
destroySurvivorOnExit: false  // 保留节点（调试）
```

---

## 🧪 测试清单

详见 `任务2.2测试说明.md`

**测试要点：**
- [x] 追捕者移动（115%速度）
- [x] 攻击功能（范围+冷却）
- [x] 踩碎木板
- [x] 游戏倒计时（5分钟）
- [x] 矿石统计
- [x] 逃脱统计
- [x] 淘汰统计
- [x] 追捕者胜利判定（淘汰≥3）
- [x] 逃生者胜利判定（逃脱≥3）
- [x] 平局判定（时间到且逃脱=2）

---

## 📊 代码统计

| 类别 | 文件数 | 总行数 |
|------|--------|--------|
| 新增脚本 | 5 | ~1300 |
| 修改脚本 | 1 | +7 |
| 文档 | 2 | ~800 |
| **合计** | **8** | **~2100** |

---

## 🔍 代码质量检查

### 设计模式

- ✅ 单例模式（GameManager）
- ✅ 回调模式（事件通知）
- ✅ 状态机模式（GameState枚举）
- ✅ 观察者模式（UI订阅数据变化）

### 性能优化

- ✅ 对象缓存（_allCharacters, _allBoards）
- ✅ 临时变量复用（_tempVec3_1, _tempVec3_2）
- ✅ 按需更新（每秒通知统计，而非每帧）
- ✅ 防重复计数（_escapedSurvivors Set）

### 代码规范

- ✅ 统一命名规范（驼峰命名）
- ✅ 详细注释（中文说明）
- ✅ 错误处理（console.error）
- ✅ 类型安全（TypeScript严格模式）

---

## 📚 文档清单

1. **任务2.2测试说明.md** - 详细测试步骤和验收标准
2. **任务2.2代码交付清单.md**（本文档）- 完整代码清单

---

## ✅ 交付验收

### 功能完整性

- [x] 追捕者可控移动（115%速度）
- [x] 攻击按钮（范围判定+冷却）
- [x] 踩碎木板功能
- [x] 5分钟倒计时
- [x] 矿石/逃脱/淘汰统计
- [x] 3种胜负判定逻辑
- [x] UI显示（倒计时+统计+结果）

### 代码质量

- [x] 无编译错误
- [x] 无TypeScript类型错误
- [x] 代码注释完整
- [x] 符合项目规范

### 文档完整性

- [x] 测试说明文档
- [x] 代码交付清单
- [x] 配置说明
- [x] 故障排查指南

---

## 🚀 后续扩展建议

1. **AI追捕者：** 基于HunterController实现自动寻路和攻击
2. **更多胜利条件：** 如收集特定数量矿石才能逃脱
3. **技能系统：** 给追捕者/逃生者添加特殊技能
4. **多人联机：** 实现真人对战模式
5. **动画系统：** 添加攻击、移动动画
6. **音效系统：** 添加背景音乐和音效

---

## 📞 技术支持

如有问题，请检查：
1. 控制台错误信息
2. 组件引用是否正确绑定
3. 场景节点结构是否完整
4. 参考 `任务2.2测试说明.md` 中的故障排查章节

---

**任务2.2交付完成！** 🎉

**版本：** V1.0
**交付日期：** 2025年
**状态：** ✅ 已完成
