# 任务4.1：联机测试指南

**文档版本**：V4.1
**创建日期**：2025-10-03
**测试目标**：验证基础房间和玩家同步功能

---

## 📋 目录

1. [测试前准备](#1-测试前准备)
2. [单人测试](#2-单人测试)
3. [双人测试（本地）](#3-双人测试本地)
4. [多人测试（3-5人）](#4-多人测试3-5人)
5. [压力测试](#5-压力测试)
6. [测试检查清单](#6-测试检查清单)

---

## 1. 测试前准备

### 1.1 启动服务器

**打开终端**，执行：
```bash
cd /Users/clare/Desktop/前哨AI小课/ClareProject/Cute-Pet-Escape-Project/server
npm run dev
```

**预期输出**：
```
============================================================
🎮 Cute Pet Escape - Multiplayer Server
============================================================
✅ Server is running on http://localhost:2567
✅ WebSocket endpoint: ws://localhost:2567
============================================================
```

**如果看到此输出**：✅ 服务器启动成功！

**如果报错**：
- `Error: listen EADDRINUSE: address already in use :::2567`
  → 端口被占用，参见《服务器部署指南》的"问题2"
- `npm ERR! code ENOENT`
  → 没有执行过 `npm install`，先运行此命令

---

### 1.2 验证服务器健康

**打开浏览器**，访问：
```
http://localhost:2567/
```

**预期响应**：
```json
{
  "status": "ok",
  "message": "Cute Pet Escape Server is running!",
  "version": "1.0.0",
  "rooms": 0
}
```

**如果看到此响应**：✅ 服务器工作正常！

---

### 1.3 打开Cocos Creator项目

1. 打开Cocos Creator
2. 打开项目：`Cute-Pet-Escape-Project/CocosProject`
3. 打开场景：`assets/scenes/LobbyScene.scene`

---

## 2. 单人测试

### 测试1：大厅UI显示

**操作步骤**：
1. 运行LobbyScene（点击播放按钮▶️）
2. 观察界面

**预期效果**：
- ✅ 看到标题："可爱宠物大逃杀 - 联机大厅"
- ✅ 玩家名称输入框有随机名字（如"快乐的小猫42"）
- ✅ "创建房间"按钮可见且可点击
- ✅ "加入房间"面板可见（输入框+按钮）
- ✅ Console显示：
  ```
  [NetworkManager] 网络管理器初始化
  [NetworkManager] Colyseus客户端创建成功
  [LobbyUI] 大厅UI初始化
  [LobbyUI] 生成随机玩家名: 快乐的小猫42
  ```

**如果失败**：
- 检查LobbyUI组件是否正确挂载和配置
- 检查所有UI元素引用是否已拖拽

---

### 测试2：随机名称生成

**操作步骤**：
1. 点击"随机"按钮
2. 重复点击3-5次

**预期效果**：
- ✅ 每次点击都生成新的随机名字
- ✅ 名字格式：`[形容词]的[名词][数字]`
- ✅ 例如："勇敢的小狗88", "聪明的小兔15"

---

### 测试3：创建房间

**操作步骤**：
1. （可选）修改玩家名称
2. 点击"创建房间"按钮
3. 观察界面和Console

**预期效果**：
- ✅ 按钮禁用（防止重复点击）
- ✅ 状态标签显示"连接中..."
- ✅ 加载面板显示（Loading...）
- ✅ Console显示：
  ```
  [LobbyUI] 创建房间中...
  [NetworkManager] 正在创建房间...
  [NetworkManager] 房间创建成功: <房间ID>
  [NetworkManager] 本地玩家会话ID: <sessionId>
  [LobbyUI] 房间创建成功，房间ID: <房间ID>
  [LobbyUI] 1秒后自动进入游戏场景...
  ```
- ✅ 1秒后自动切换到GameScene

**记录房间ID**：
- 在Console中找到类似 `房间ID: abc123def456` 的日志
- **复制此房间ID**（后续测试需要）

---

### 测试4：游戏场景显示

**操作步骤**：
1. 自动进入GameScene后，观察界面

**预期效果**：
- ✅ 看到游戏场景（地形、本地玩家模型等）
- ✅ 左上角显示RoomUI：
  - "房间ID: abc123def456"
  - "玩家: 1/5"
  - "已连接"（绿色）
- ✅ Console显示：
  ```
  [RoomUI] 房间UI初始化
  [RemotePlayerManager] 远程玩家管理器初始化
  [RemotePlayerManager] 当前房间有 1 个玩家
  [PlayerSyncController] 玩家同步控制器初始化
  ```

---

### 测试5：玩家移动同步

**操作步骤**：
1. 使用WASD或方向键移动本地玩家
2. 观察Console输出

**预期效果**：
- ✅ 玩家角色正常移动
- ✅ Console显示同步日志（如果启用了enableDebugLog）：
  ```
  [PlayerSyncController] 同步状态: pos(1.23, 0.00), rot(45.0), moving(true)
  [PlayerSyncController] 同步状态: pos(2.45, 0.00), rot(45.0), moving(true)
  ```
- ✅ 停止移动时，同步日志显示 `moving(false)`

**检查服务器**：
1. 打开终端查看服务器Console
2. 应该看到消息处理日志（如果服务器启用了日志）

---

### 测试6：查看房间列表

**操作步骤**：
1. 打开浏览器
2. 访问：`http://localhost:2567/rooms`

**预期响应**：
```json
{
  "success": true,
  "rooms": [
    {
      "roomId": "abc123def456",
      "clients": 1,
      "maxClients": 5,
      "metadata": {
        "roomName": "快乐的小猫42的房间",
        "createdAt": 1696320000000
      }
    }
  ]
}
```

**验证内容**：
- ✅ `roomId` 与游戏中显示的房间ID一致
- ✅ `clients` 为 1（当前只有你一个人）
- ✅ `maxClients` 为 5

---

## 3. 双人测试（本地）

### 方法1：使用两个浏览器窗口（推荐）

#### 准备工作

**窗口1（房主）**：
1. 在Cocos Creator中运行LobbyScene
2. 点击"创建房间"
3. 记下房间ID（例如：`abc123`）
4. 浏览器会自动打开游戏
5. **不要关闭此窗口**

**窗口2（加入者）**：
1. **再次点击Cocos Creator的运行按钮▶️**
2. 会打开新的浏览器窗口
3. 在大厅界面，输入房间ID：`abc123`
4. 点击"加入"按钮

---

#### 测试步骤

**测试1：加入房间**

**预期效果（窗口2）**：
- ✅ 状态标签显示"连接中..."
- ✅ Console显示：
  ```
  [NetworkManager] 正在加入房间: abc123
  [NetworkManager] 成功加入房间: abc123
  ```
- ✅ 1秒后自动切换到GameScene

**预期效果（窗口1）**：
- ✅ RoomUI更新："玩家: 2/5"
- ✅ Console显示：
  ```
  [RemotePlayerManager] 新玩家加入: <sessionId>
  [RemotePlayerManager] 创建远程玩家成功: 勇敢的小狗88 (<sessionId>)
  [RemotePlayerManager] 当前远程玩家数: 1
  ```
- ✅ 场景中出现新的玩家模型（远程玩家）

---

**测试2：查看远程玩家**

**操作步骤（窗口1）**：
1. 观察场景中是否有第二个玩家模型
2. 检查Hierarchy面板（如果是Cocos Creator运行）

**预期效果**：
- ✅ 场景中有两个玩家模型：
  - 本地玩家（你控制的）
  - 远程玩家（第二个玩家）
- ✅ 远程玩家节点名称类似：`RemotePlayer_勇敢的小狗88_a1b2`
- ✅ 远程玩家有可见的3D模型

---

**测试3：移动同步（窗口2移动）**

**操作步骤**：
1. 在**窗口2**中，使用WASD移动你的角色
2. 观察**窗口1**中的远程玩家

**预期效果（窗口1）**：
- ✅ 远程玩家实时移动
- ✅ 移动流畅，没有明显卡顿
- ✅ Console显示（如果启用调试）：
  ```
  [RemotePlayerController] 更新状态: 勇敢的小狗88, pos(1.23, 0.00), moving(true)
  ```

**测试反向同步**：
1. 在**窗口1**中移动
2. 观察**窗口2**中的远程玩家
3. 应该也能看到实时移动

---

**测试4：旋转同步**

**操作步骤**：
1. 在**窗口2**中，移动鼠标旋转视角
2. 让角色朝向不同方向
3. 观察**窗口1**中的远程玩家

**预期效果**：
- ✅ 远程玩家的朝向随之改变
- ✅ 旋转平滑，没有跳跃

---

**测试5：动画同步**

**操作步骤**：
1. 在**窗口2**中：
   - 移动时观察动画
   - 停止移动后观察动画
2. 在**窗口1**中观察远程玩家

**预期效果**：
- ✅ 远程玩家移动时播放"跑步"动画
- ✅ 远程玩家停止时播放"待机"动画
- ✅ 动画切换流畅

---

**测试6：离开房间**

**操作步骤**：
1. 关闭**窗口2**（或点击"离开房间"按钮）
2. 观察**窗口1**

**预期效果（窗口1）**：
- ✅ RoomUI更新："玩家: 1/5"
- ✅ Console显示：
  ```
  [RemotePlayerManager] 玩家离开: <sessionId>
  [RemotePlayerManager] 销毁远程玩家: <sessionId>
  [RemotePlayerManager] 当前远程玩家数: 0
  ```
- ✅ 远程玩家模型从场景中消失

---

### 方法2：构建Web版本（更真实）

#### 构建步骤

1. Cocos Creator → **"项目"** → **"构建发布"**
2. 配置构建：
   - **发布平台**：Web Mobile
   - **构建路径**：默认
   - **调试模式**：勾选（测试时）
3. 点击 **"构建"**
4. 等待构建完成（1-3分钟）
5. 点击 **"运行"**（会在浏览器中打开）

#### 测试步骤

1. 浏览器会自动打开游戏，地址类似：
   ```
   http://localhost:7456/index.html
   ```
2. 创建房间，记下房间ID
3. **打开新的浏览器窗口**（Ctrl+N / Cmd+N）
4. 访问相同地址：`http://localhost:7456/index.html`
5. 在第二个窗口中，输入房间ID加入

**然后执行上述"测试1-6"**

---

### 方法3：不同设备（同一局域网）

#### 获取本机IP地址

**macOS**：
```bash
ifconfig | grep "inet " | grep -v 127.0.0.1
```

**Windows**：
```bash
ipconfig
```

记下你的局域网IP，例如：`192.168.1.100`

#### 修改客户端配置

1. 在Cocos Creator中，找到NetworkManager组件
2. 修改 `serverUrl`：
   ```
   从：ws://localhost:2567
   改为：ws://192.168.1.100:2567
   ```
3. 重新构建Web版本

#### 测试步骤

1. 在主机上运行服务器（IP: 192.168.1.100）
2. 在主机上打开游戏，创建房间
3. 在另一台设备上：
   - 打开浏览器
   - 访问：`http://192.168.1.100:7456/index.html`
   - 输入房间ID加入

---

## 4. 多人测试（3-5人）

### 测试目标

验证房间支持最多5人同时在线。

### 准备工作

**方法1：多个浏览器窗口**
- 打开5个浏览器窗口
- 第1个窗口：创建房间
- 第2-5个窗口：依次加入房间

**方法2：多台设备**
- 使用多台电脑/手机
- 确保在同一局域网
- 配置IP地址（参见"方法3"）

---

### 测试步骤

**测试1：依次加入**

1. **窗口1**：创建房间，记下房间ID
2. **窗口2**：加入房间
   - 验证窗口1显示"玩家: 2/5"
   - 验证窗口1和2都能看到对方
3. **窗口3**：加入房间
   - 验证所有窗口显示"玩家: 3/5"
   - 验证窗口1和2能看到新玩家
   - 验证窗口3能看到前两个玩家
4. **窗口4、5**：重复上述步骤

**预期效果**：
- ✅ 所有玩家都能看到其他所有玩家
- ✅ RoomUI显示正确的玩家数量
- ✅ Console显示正确的远程玩家数：
  ```
  窗口1：当前远程玩家数: 4
  窗口2：当前远程玩家数: 4
  窗口3：当前远程玩家数: 4
  窗口4：当前远程玩家数: 4
  窗口5：当前远程玩家数: 4
  ```

---

**测试2：同时移动**

**操作步骤**：
1. 5个窗口同时操作，随意移动各自的角色
2. 观察每个窗口中的远程玩家

**预期效果**：
- ✅ 所有远程玩家都在实时移动
- ✅ 移动流畅，无明显延迟
- ✅ 无掉线或卡死

---

**测试3：房间已满**

**操作步骤**：
1. 5人都在房间内时
2. 打开第6个窗口
3. 尝试加入同一房间

**预期效果**：
- ✅ 加入失败
- ✅ 状态标签显示"房间已满"（或类似错误）
- ✅ Console显示错误信息

---

**测试4：中途离开**

**操作步骤**：
1. 5人都在房间内
2. 关闭**窗口3**
3. 观察其他窗口

**预期效果（所有窗口）**：
- ✅ RoomUI更新："玩家: 4/5"
- ✅ 窗口3对应的远程玩家消失
- ✅ Console显示：
  ```
  [RemotePlayerManager] 玩家离开: <sessionId>
  ```

**然后新窗口加入**：
1. 打开新窗口
2. 输入房间ID加入

**预期效果**：
- ✅ 加入成功（因为有空位了）
- ✅ 所有窗口显示"玩家: 5/5"

---

## 5. 压力测试

### 测试1：快速移动

**操作步骤**：
1. 2人在房间内
2. 快速按键移动，频繁改变方向
3. 观察对方的远程玩家

**预期效果**：
- ✅ 远程玩家移动流畅，无卡顿
- ✅ 无明显延迟（<200ms）
- ✅ 无丢失同步

---

### 测试2：长时间在线

**操作步骤**：
1. 2人在房间内
2. 保持连接10分钟
3. 期间随意移动

**预期效果**：
- ✅ 连接稳定，无断线
- ✅ 同步正常，无漂移
- ✅ 内存使用稳定（无内存泄漏）

**检查内存**：
- 浏览器 → F12 → Performance → Memory
- 观察内存曲线是否平稳

---

### 测试3：频繁进出房间

**操作步骤**：
1. 创建房间 → 立即离开
2. 重复10次
3. 检查服务器状态

**预期效果**：
- ✅ 每次都能成功创建和离开
- ✅ 房间正确销毁（30秒后）
- ✅ 服务器无崩溃

**验证房间销毁**：
- 访问 `http://localhost:2567/rooms`
- 30秒后，空房间应该从列表中消失

---

### 测试4：网络中断恢复

**操作步骤**：
1. 2人在房间内
2. 暂时断开一个玩家的网络（关闭WiFi或拔网线）
3. 10秒后恢复网络

**预期效果**：
- ✅ 断网时，对方看到该玩家离线
- ✅ 恢复网络后，可以重新创建/加入房间
- ✅ 服务器正确处理超时断开

---

## 6. 测试检查清单

### ✅ 基础功能

- [ ] 大厅UI正确显示
- [ ] 随机名称生成正常
- [ ] 创建房间成功
- [ ] 加入房间成功（正确房间ID）
- [ ] 加入房间失败（错误房间ID）
- [ ] 房间UI显示正确信息
- [ ] 服务器健康检查正常
- [ ] 房间列表API正常

---

### ✅ 玩家同步

- [ ] 本地玩家移动正常
- [ ] 本地玩家状态正确发送到服务器
- [ ] 远程玩家正确创建
- [ ] 远程玩家位置实时同步
- [ ] 远程玩家旋转实时同步
- [ ] 远程玩家动画正确播放（跑/待机）
- [ ] 远程玩家移动流畅（插值正常）
- [ ] 远程玩家正确销毁（离开时）

---

### ✅ 多人功能

- [ ] 2人同时在线正常
- [ ] 3-5人同时在线正常
- [ ] 房间满员时拒绝新玩家
- [ ] 玩家离开后，其他玩家正确更新
- [ ] 新玩家加入时，能看到所有现有玩家
- [ ] 所有玩家都能看到其他所有玩家
- [ ] 玩家数量显示正确

---

### ✅ 性能和稳定性

- [ ] 无明显卡顿或延迟
- [ ] 长时间在线无断连
- [ ] 无内存泄漏
- [ ] 频繁进出房间无问题
- [ ] 空房间正确销毁（30秒后）
- [ ] 服务器无崩溃
- [ ] Console无错误日志

---

### ✅ 错误处理

- [ ] 房间ID错误时显示错误信息
- [ ] 房间已满时显示错误信息
- [ ] 网络断开时正确提示
- [ ] 服务器关闭时正确提示
- [ ] 重复创建房间时正确处理
- [ ] 异常断线后能重新加入

---

## 7. 常见测试问题

### 问题1：第二个窗口加入房间后，第一个窗口看不到

**检查**：
1. Console是否显示"新玩家加入"？
2. RemotePlayerManager是否正确配置？
3. RemotePlayer预制体是否正确？
4. 查看Scene视图，远程玩家是否在视野外？

---

### 问题2：远程玩家不移动

**检查**：
1. PlayerSyncController是否挂载在本地玩家上？
2. Console是否显示同步日志？
3. 服务器Console是否收到消息？
4. RemotePlayerController的enableSmoothing是否勾选？

---

### 问题3：延迟很高（>500ms）

**原因**：
- 同步频率太高
- 服务器性能不足
- 网络质量差

**解决方案**：
1. 降低同步频率：`syncInterval = 0.1` (10次/秒)
2. 检查服务器CPU使用率
3. 使用有线网络代替WiFi

---

### 问题4：玩家位置跳跃

**原因**：
- 插值速度太低
- 网络丢包

**解决方案**：
1. 提高插值速度：`interpolationSpeed = 15`
2. 检查网络稳定性
3. 启用snapThreshold防止过大偏移

---

## 8. 测试报告模板

```
【任务4.1联机测试报告】

测试日期：2025-10-03
测试人员：Clare
服务器版本：1.0.0
客户端版本：Cocos Creator 3.6.x

## 测试环境
- 服务器：本地 (ws://localhost:2567)
- 客户端：Web浏览器
- 测试设备：[列出设备]
- 网络环境：局域网

## 测试结果

### 基础功能（8/8通过）
✅ 大厅UI显示
✅ 创建房间
✅ 加入房间
✅ 房间UI显示
✅ 服务器健康检查
✅ 房间列表API
✅ 随机名称生成
✅ 错误处理

### 玩家同步（8/8通过）
✅ 位置同步
✅ 旋转同步
✅ 动画同步
✅ 插值流畅
✅ 远程玩家创建
✅ 远程玩家销毁
✅ 本地玩家发送
✅ 变化检测

### 多人功能（7/7通过）
✅ 2人在线
✅ 5人在线
✅ 房间满员处理
✅ 玩家离开处理
✅ 新玩家加入
✅ 互相可见
✅ 玩家数量显示

### 性能和稳定性（7/7通过）
✅ 无明显延迟
✅ 长时间在线稳定
✅ 无内存泄漏
✅ 频繁进出正常
✅ 空房间销毁
✅ 服务器稳定
✅ 无错误日志

## 发现的问题
1. [描述问题1]
2. [描述问题2]

## 建议和改进
1. [建议1]
2. [建议2]

## 总体评价
✅ 通过 / ❌ 未通过

## 备注
[其他说明]
```

---

## 9. 下一步

完成测试后：
1. ✅ 填写测试报告
2. ✅ 修复发现的问题
3. ✅ 准备云服务器部署（如果需要）
4. ✅ 开始【任务4.2】：同步游戏玩法

---

**文档生成时间**：2025-10-03
**适用版本**：Task 4.1 - 基础房间和玩家同步
**测试状态**：✅ 测试指南就绪
