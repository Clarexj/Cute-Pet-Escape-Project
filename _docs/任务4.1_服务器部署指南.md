# ä»»åŠ¡4.1ï¼šç½‘ç»œè”æœºæœåŠ¡å™¨éƒ¨ç½²æŒ‡å—

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šV4.1
**åˆ›å»ºæ—¥æœŸ**ï¼š2025-10-02
**æŠ€æœ¯æ–¹æ¡ˆ**ï¼šColyseus + Node.js

---

## ğŸ“‹ ç›®å½•

1. [ç¯å¢ƒå‡†å¤‡](#1-ç¯å¢ƒå‡†å¤‡)
2. [æœ¬åœ°å¼€å‘éƒ¨ç½²](#2-æœ¬åœ°å¼€å‘éƒ¨ç½²)
3. [äº‘æœåŠ¡å™¨éƒ¨ç½²ï¼ˆå¯é€‰ï¼‰](#3-äº‘æœåŠ¡å™¨éƒ¨ç½²å¯é€‰)
4. [å¸¸è§é—®é¢˜æ’æŸ¥](#4-å¸¸è§é—®é¢˜æ’æŸ¥)

---

## 1. ç¯å¢ƒå‡†å¤‡

### 1.1 å®‰è£…Node.js

**æ£€æŸ¥æ˜¯å¦å·²å®‰è£…**ï¼š
```bash
node --version
npm --version
```

**å¦‚æœæœªå®‰è£…**ï¼š
1. è®¿é—® https://nodejs.org/
2. ä¸‹è½½å¹¶å®‰è£… **LTSç‰ˆæœ¬**ï¼ˆæ¨è18.xæˆ–20.xï¼‰
3. å®‰è£…å®Œæˆåé‡æ–°æ£€æŸ¥ç‰ˆæœ¬

**é¢„æœŸè¾“å‡º**ï¼š
```
node --version
v18.17.0  (ç‰ˆæœ¬å·å¯èƒ½ä¸åŒ)

npm --version
9.6.7  (ç‰ˆæœ¬å·å¯èƒ½ä¸åŒ)
```

---

### 1.2 å®‰è£…ä¾èµ–åŒ…

**è¿›å…¥æœåŠ¡å™¨ç›®å½•**ï¼š
```bash
cd /Users/clare/Desktop/å‰å“¨AIå°è¯¾/ClareProject/Cute-Pet-Escape-Project/server
```

**å®‰è£…æ‰€æœ‰ä¾èµ–**ï¼š
```bash
npm install
```

**é¢„æœŸè¾“å‡º**ï¼š
```
added 150 packages, and audited 151 packages in 15s
found 0 vulnerabilities
```

**å®‰è£…è¿‡ç¨‹è¯´æ˜**ï¼š
- è¿™ä¸ªå‘½ä»¤ä¼šè¯»å–`package.json`
- è‡ªåŠ¨ä¸‹è½½å¹¶å®‰è£…æ‰€æœ‰å¿…éœ€çš„åŒ…ï¼ˆColyseusã€Expressç­‰ï¼‰
- åˆ›å»º`node_modules`æ–‡ä»¶å¤¹
- é¦–æ¬¡å®‰è£…éœ€è¦1-3åˆ†é’Ÿï¼ˆå–å†³äºç½‘é€Ÿï¼‰

---

## 2. æœ¬åœ°å¼€å‘éƒ¨ç½²

### 2.1 å¯åŠ¨å¼€å‘æœåŠ¡å™¨

**æ–¹æ³•1ï¼šä½¿ç”¨å¼€å‘æ¨¡å¼ï¼ˆæ¨èï¼‰**
```bash
npm run dev
```

**æ–¹æ³•2ï¼šä½¿ç”¨ç”Ÿäº§æ¨¡å¼**
```bash
npm start
```

**åŒºåˆ«**ï¼š
| æ–¹å¼ | è‡ªåŠ¨é‡å¯ | ç¼–è¯‘é€Ÿåº¦ | é€‚ç”¨åœºæ™¯ |
|------|---------|---------|---------|
| `npm run dev` | âœ… ä»£ç ä¿®æ”¹åè‡ªåŠ¨é‡å¯ | å¿« | å¼€å‘è°ƒè¯• |
| `npm start` | âŒ éœ€æ‰‹åŠ¨é‡å¯ | å¿« | æµ‹è¯•/æ¼”ç¤º |

---

### 2.2 éªŒè¯æœåŠ¡å™¨å¯åŠ¨æˆåŠŸ

**é¢„æœŸConsoleè¾“å‡º**ï¼š
```
============================================================
ğŸ® Cute Pet Escape - Multiplayer Server
============================================================
âœ… Server is running on http://localhost:2567
âœ… WebSocket endpoint: ws://localhost:2567
============================================================
ğŸ“‹ Available endpoints:
   GET  http://localhost:2567/         - Health check
   GET  http://localhost:2567/rooms    - List all rooms
============================================================
ğŸš€ Server is ready to accept connections!
============================================================
```

**å¦‚æœçœ‹åˆ°æ­¤è¾“å‡º**ï¼šâœ… æœåŠ¡å™¨å¯åŠ¨æˆåŠŸï¼

---

### 2.3 æµ‹è¯•æœåŠ¡å™¨è¿æ¥

**æ‰“å¼€æµè§ˆå™¨**ï¼Œè®¿é—®ä»¥ä¸‹URLï¼š

#### æµ‹è¯•1ï¼šå¥åº·æ£€æŸ¥
```
http://localhost:2567/
```

**é¢„æœŸå“åº”**ï¼š
```json
{
  "status": "ok",
  "message": "Cute Pet Escape Server is running!",
  "version": "1.0.0",
  "rooms": 0
}
```

#### æµ‹è¯•2ï¼šæŸ¥çœ‹æˆ¿é—´åˆ—è¡¨
```
http://localhost:2567/rooms
```

**é¢„æœŸå“åº”**ï¼ˆåˆå§‹çŠ¶æ€ï¼‰ï¼š
```json
{
  "success": true,
  "rooms": []
}
```

**å¦‚æœä¸¤ä¸ªæµ‹è¯•éƒ½æˆåŠŸ**ï¼šâœ… æœåŠ¡å™¨å·¥ä½œæ­£å¸¸ï¼

---

### 2.4 é…ç½®é˜²ç«å¢™ï¼ˆå¦‚æœ‰å¿…è¦ï¼‰

**macOS**ï¼š
1. ç³»ç»Ÿåå¥½è®¾ç½® â†’ å®‰å…¨æ€§ä¸éšç§ â†’ é˜²ç«å¢™
2. å¦‚æœæç¤º"æ˜¯å¦å…è®¸Node.jsæ¥å—ä¼ å…¥è¿æ¥"ï¼Œç‚¹å‡»**å…è®¸**

**Windows**ï¼š
1. Windows Defenderé˜²ç«å¢™å¯èƒ½ä¼šå¼¹çª—
2. å‹¾é€‰"ä¸“ç”¨ç½‘ç»œ"å’Œ"å…¬ç”¨ç½‘ç»œ"
3. ç‚¹å‡»**å…è®¸è®¿é—®**

---

## 3. äº‘æœåŠ¡å™¨éƒ¨ç½²ï¼ˆå¯é€‰ï¼‰

### 3.1 ä½¿ç”¨Render.comï¼ˆå…è´¹ï¼‰

#### æ­¥éª¤1ï¼šæ³¨å†ŒRenderè´¦å·
1. è®¿é—® https://render.com
2. ä½¿ç”¨GitHubè´¦å·ç™»å½•ï¼ˆæ¨èï¼‰

#### æ­¥éª¤2ï¼šæ¨é€ä»£ç åˆ°GitHub
```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•
cd /Users/clare/Desktop/å‰å“¨AIå°è¯¾/ClareProject/Cute-Pet-Escape-Project

# åˆå§‹åŒ–Gitï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰
git init
git add server/
git commit -m "Add Colyseus server"

# æ¨é€åˆ°GitHub
git remote add origin <ä½ çš„GitHubä»“åº“åœ°å€>
git push -u origin main
```

#### æ­¥éª¤3ï¼šåœ¨Renderåˆ›å»ºWeb Service
1. ç™»å½•Render â†’ Dashboard â†’ "New +"
2. é€‰æ‹©"Web Service"
3. è¿æ¥GitHubä»“åº“
4. é…ç½®ï¼š
   - **Name**: `cute-pet-escape-server`
   - **Root Directory**: `server`
   - **Build Command**: `npm install && npm run build`
   - **Start Command**: `npm start`
   - **Instance Type**: Free

5. ç‚¹å‡»"Create Web Service"
6. ç­‰å¾…éƒ¨ç½²ï¼ˆ3-5åˆ†é’Ÿï¼‰

#### æ­¥éª¤4ï¼šè·å–æœåŠ¡å™¨åœ°å€
éƒ¨ç½²æˆåŠŸåï¼ŒRenderä¼šæä¾›ä¸€ä¸ªURLï¼Œä¾‹å¦‚ï¼š
```
https://cute-pet-escape-server.onrender.com
```

#### æ­¥éª¤5ï¼šä¿®æ”¹å®¢æˆ·ç«¯æœåŠ¡å™¨åœ°å€
åœ¨Cocos Creatorä¸­ï¼Œä¿®æ”¹NetworkManagerçš„`serverUrl`ï¼š
```typescript
// ä»
public serverUrl: string = "ws://localhost:2567";

// æ”¹ä¸ºï¼ˆæ³¨æ„wsæ”¹ä¸ºwssï¼‰
public serverUrl: string = "wss://cute-pet-escape-server.onrender.com";
```

---

### 3.2 ä½¿ç”¨Railway.appï¼ˆå…è´¹ï¼‰

#### æ­¥éª¤1ï¼šæ³¨å†ŒRailwayè´¦å·
1. è®¿é—® https://railway.app
2. ä½¿ç”¨GitHubè´¦å·ç™»å½•

#### æ­¥éª¤2ï¼šéƒ¨ç½²
1. Dashboard â†’ "New Project"
2. é€‰æ‹©"Deploy from GitHub repo"
3. é€‰æ‹©ä½ çš„ä»“åº“
4. Railwayä¼šè‡ªåŠ¨æ£€æµ‹Node.jsé¡¹ç›®
5. è®¾ç½®ç¯å¢ƒå˜é‡ï¼ˆå¦‚éœ€è¦ï¼‰ï¼š
   - `PORT`: 2567

#### æ­¥éª¤3ï¼šè·å–åŸŸå
1. ç‚¹å‡»ä½ çš„æœåŠ¡ â†’ Settings â†’ Domains
2. ç‚¹å‡»"Generate Domain"
3. è·å¾—ç±»ä¼¼ `your-app.up.railway.app` çš„åŸŸå

#### æ­¥éª¤4ï¼šä¿®æ”¹å®¢æˆ·ç«¯
```typescript
public serverUrl: string = "wss://your-app.up.railway.app";
```

---

### 3.3 æœ¬åœ°æœåŠ¡å™¨å¤–ç½‘è®¿é—®ï¼ˆä½¿ç”¨ngrokï¼‰

**å¦‚æœä½ æƒ³è®©æœ‹å‹åœ¨å¤–ç½‘æµ‹è¯•ï¼Œä½†ä¸æƒ³éƒ¨ç½²åˆ°äº‘æœåŠ¡å™¨**ï¼š

#### æ­¥éª¤1ï¼šå®‰è£…ngrok
```bash
# macOS (ä½¿ç”¨Homebrew)
brew install ngrok

# æˆ–è®¿é—® https://ngrok.com ä¸‹è½½
```

#### æ­¥éª¤2ï¼šå¯åŠ¨æœ¬åœ°æœåŠ¡å™¨
```bash
cd server
npm run dev
```

#### æ­¥éª¤3ï¼šä½¿ç”¨ngrokåˆ›å»ºéš§é“
**æ–°å¼€ä¸€ä¸ªç»ˆç«¯**ï¼š
```bash
ngrok http 2567
```

#### æ­¥éª¤4ï¼šè·å–å…¬ç½‘åœ°å€
ngrokä¼šæ˜¾ç¤ºï¼š
```
Forwarding   https://abc123.ngrok.io -> http://localhost:2567
```

#### æ­¥éª¤5ï¼šä¿®æ”¹å®¢æˆ·ç«¯
```typescript
public serverUrl: string = "wss://abc123.ngrok.io";
```

**æ³¨æ„**ï¼š
- âœ… å…è´¹ç‰ˆngrokçš„åœ°å€æ¯æ¬¡å¯åŠ¨éƒ½ä¼šå˜åŒ–
- âœ… é€‚åˆä¸´æ—¶æµ‹è¯•
- âŒ ä¸é€‚åˆé•¿æœŸä½¿ç”¨

---

## 4. å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜1ï¼š`npm install`å¤±è´¥

**é”™è¯¯ä¿¡æ¯**ï¼š
```
npm ERR! code EACCES
npm ERR! syscall access
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# macOS/Linux
sudo npm install

# æˆ–æ›´æ”¹npmå…¨å±€ç›®å½•æƒé™
mkdir ~/.npm-global
npm config set prefix '~/.npm-global'
export PATH=~/.npm-global/bin:$PATH
```

---

### é—®é¢˜2ï¼šç«¯å£2567è¢«å ç”¨

**é”™è¯¯ä¿¡æ¯**ï¼š
```
Error: listen EADDRINUSE: address already in use :::2567
```

**è§£å†³æ–¹æ¡ˆ1ï¼šæŸ¥æ‰¾å¹¶æ€æ­»å ç”¨è¿›ç¨‹**
```bash
# macOS/Linux
lsof -i :2567
kill -9 <PID>

# Windows
netstat -ano | findstr :2567
taskkill /PID <PID> /F
```

**è§£å†³æ–¹æ¡ˆ2ï¼šæ›´æ”¹ç«¯å£**
```bash
# å¯åŠ¨æ—¶æŒ‡å®šç«¯å£
PORT=3000 npm start

# ç„¶åä¿®æ”¹å®¢æˆ·ç«¯è¿æ¥åœ°å€ä¸º ws://localhost:3000
```

---

### é—®é¢˜3ï¼šå®¢æˆ·ç«¯è¿æ¥å¤±è´¥

**æ£€æŸ¥æ¸…å•**ï¼š
1. âœ… æœåŠ¡å™¨æ˜¯å¦æ­£åœ¨è¿è¡Œï¼Ÿ
   ```bash
   # è®¿é—® http://localhost:2567/ æ˜¯å¦æœ‰å“åº”
   ```

2. âœ… æœåŠ¡å™¨åœ°å€æ˜¯å¦æ­£ç¡®ï¼Ÿ
   ```typescript
   // æœ¬åœ°ï¼šws://localhost:2567
   // äº‘ç«¯ï¼šwss://your-domain.com
   ```

3. âœ… æ˜¯å¦ä½¿ç”¨äº†æ­£ç¡®çš„åè®®ï¼Ÿ
   ```
   æœ¬åœ°HTTP â†’ ws://
   äº‘ç«¯HTTPS â†’ wss://
   ```

4. âœ… é˜²ç«å¢™æ˜¯å¦å…è®¸ï¼Ÿ
   - æ£€æŸ¥ç³»ç»Ÿé˜²ç«å¢™è®¾ç½®
   - æ£€æŸ¥æ€æ¯’è½¯ä»¶æ˜¯å¦æ‹¦æˆª

---

### é—®é¢˜4ï¼šCORSè·¨åŸŸé”™è¯¯

**é”™è¯¯ä¿¡æ¯ï¼ˆæµè§ˆå™¨Consoleï¼‰**ï¼š
```
Access to XMLHttpRequest has been blocked by CORS policy
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
æœåŠ¡å™¨ä»£ç å·²åŒ…å«CORSé…ç½®ï¼š
```typescript
// server/src/index.ts
app.use(cors());  // âœ… å·²é…ç½®
```

å¦‚æœä»æœ‰é—®é¢˜ï¼Œä¿®æ”¹ä¸ºï¼š
```typescript
app.use(cors({
    origin: '*',  // å…è®¸æ‰€æœ‰åŸŸåï¼ˆå¼€å‘ç¯å¢ƒï¼‰
    credentials: true
}));
```

---

### é—®é¢˜5ï¼šTypeScriptç¼–è¯‘é”™è¯¯

**é”™è¯¯ä¿¡æ¯**ï¼š
```
error TS2307: Cannot find module '@colyseus/core'
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
```bash
# åˆ é™¤node_moduleså’Œé”æ–‡ä»¶
rm -rf node_modules package-lock.json

# é‡æ–°å®‰è£…
npm install

# å¦‚æœè¿˜æ˜¯ä¸è¡Œï¼Œå°è¯•å®‰è£…ç‰¹å®šç‰ˆæœ¬
npm install @colyseus/core@0.15.0 --save
```

---

### é—®é¢˜6ï¼šå®¢æˆ·ç«¯Colyseusåº“æœªå®‰è£…

**é”™è¯¯ä¿¡æ¯ï¼ˆCocos Creator Consoleï¼‰**ï¼š
```
Cannot find module 'colyseus.js'
```

**è§£å†³æ–¹æ¡ˆ**ï¼š
å‚è§`ä»»åŠ¡4.1_å®¢æˆ·ç«¯é…ç½®æŒ‡å—.md`çš„ç¬¬2ç« èŠ‚ã€‚

---

## 5. æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 5.1 åŒæ­¥é¢‘ç‡ä¼˜åŒ–

**é»˜è®¤è®¾ç½®**ï¼š
```typescript
// PlayerSyncController.ts
public syncInterval: number = 0.05; // 20æ¬¡/ç§’
```

**æ ¹æ®ç½‘ç»œæƒ…å†µè°ƒæ•´**ï¼š
| ç½‘ç»œè´¨é‡ | æ¨èé¢‘ç‡ | syncIntervalå€¼ |
|---------|---------|---------------|
| ä¼˜ç§€ï¼ˆ<50msï¼‰ | 30æ¬¡/ç§’ | 0.033 |
| è‰¯å¥½ï¼ˆ50-100msï¼‰ | 20æ¬¡/ç§’ | 0.05 |
| ä¸€èˆ¬ï¼ˆ100-200msï¼‰ | 15æ¬¡/ç§’ | 0.067 |
| è¾ƒå·®ï¼ˆ>200msï¼‰ | 10æ¬¡/ç§’ | 0.1 |

---

### 5.2 æœåŠ¡å™¨æ€§èƒ½ç›‘æ§

**æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—**ï¼š
```bash
# å¦‚æœä½¿ç”¨pm2ç®¡ç†è¿›ç¨‹
pm2 logs

# å¦‚æœç›´æ¥è¿è¡Œ
# æŸ¥çœ‹Consoleè¾“å‡º
```

**ç›‘æ§æŒ‡æ ‡**ï¼š
- æˆ¿é—´æ•°é‡
- ç©å®¶æ•°é‡
- æ¶ˆæ¯é¢‘ç‡
- å†…å­˜ä½¿ç”¨

---

## 6. ç”Ÿäº§ç¯å¢ƒå»ºè®®

### 6.1 ä½¿ç”¨è¿›ç¨‹ç®¡ç†å™¨ï¼ˆPM2ï¼‰

**å®‰è£…PM2**ï¼š
```bash
npm install -g pm2
```

**å¯åŠ¨æœåŠ¡å™¨**ï¼š
```bash
cd server
pm2 start lib/index.js --name "cute-pet-escape"
```

**å¸¸ç”¨å‘½ä»¤**ï¼š
```bash
pm2 list          # æŸ¥çœ‹æ‰€æœ‰è¿›ç¨‹
pm2 logs          # æŸ¥çœ‹æ—¥å¿—
pm2 restart all   # é‡å¯
pm2 stop all      # åœæ­¢
pm2 delete all    # åˆ é™¤
```

---

### 6.2 é…ç½®ç¯å¢ƒå˜é‡

**åˆ›å»º`.env`æ–‡ä»¶**ï¼š
```bash
# server/.env
PORT=2567
NODE_ENV=production
```

**ä¿®æ”¹ä»£ç è¯»å–**ï¼š
```typescript
// server/src/index.ts
import dotenv from 'dotenv';
dotenv.config();

const PORT = process.env.PORT || 2567;
```

---

## 7. ä¸‹ä¸€æ­¥

æœåŠ¡å™¨éƒ¨ç½²å®Œæˆåï¼š
1. âœ… éªŒè¯æœåŠ¡å™¨è®¿é—®æ­£å¸¸
2. âœ… é…ç½®å®¢æˆ·ç«¯è¿æ¥åœ°å€
3. âœ… å‚è§`ä»»åŠ¡4.1_å®¢æˆ·ç«¯é…ç½®æŒ‡å—.md`å®ŒæˆCocos Creatoré…ç½®
4. âœ… å‚è§`ä»»åŠ¡4.1_è”æœºæµ‹è¯•æŒ‡å—.md`è¿›è¡ŒåŒäººæµ‹è¯•

---

**æ–‡æ¡£ç”Ÿæˆæ—¶é—´**ï¼š2025-10-02
**é€‚ç”¨ç‰ˆæœ¬**ï¼šNode.js 18.x+, Colyseus 0.15.x
**éƒ¨ç½²çŠ¶æ€**ï¼šâœ… æœ¬åœ°å¼€å‘å°±ç»ª
