# 任务4.1：网络联机服务器部署指南

**文档版本**：V4.1
**创建日期**：2025-10-02
**技术方案**：Colyseus + Node.js

---

## 📋 目录

1. [环境准备](#1-环境准备)
2. [本地开发部署](#2-本地开发部署)
3. [云服务器部署（可选）](#3-云服务器部署可选)
4. [常见问题排查](#4-常见问题排查)

---

## 1. 环境准备

### 1.1 安装Node.js

**检查是否已安装**：
```bash
node --version
npm --version
```

**如果未安装**：
1. 访问 https://nodejs.org/
2. 下载并安装 **LTS版本**（推荐18.x或20.x）
3. 安装完成后重新检查版本

**预期输出**：
```
node --version
v18.17.0  (版本号可能不同)

npm --version
9.6.7  (版本号可能不同)
```

---

### 1.2 安装依赖包

**进入服务器目录**：
```bash
cd /Users/clare/Desktop/前哨AI小课/ClareProject/Cute-Pet-Escape-Project/server
```

**安装所有依赖**：
```bash
npm install
```

**预期输出**：
```
added 150 packages, and audited 151 packages in 15s
found 0 vulnerabilities
```

**安装过程说明**：
- 这个命令会读取`package.json`
- 自动下载并安装所有必需的包（Colyseus、Express等）
- 创建`node_modules`文件夹
- 首次安装需要1-3分钟（取决于网速）

---

## 2. 本地开发部署

### 2.1 启动开发服务器

**方法1：使用开发模式（推荐）**
```bash
npm run dev
```

**方法2：使用生产模式**
```bash
npm start
```

**区别**：
| 方式 | 自动重启 | 编译速度 | 适用场景 |
|------|---------|---------|---------|
| `npm run dev` | ✅ 代码修改后自动重启 | 快 | 开发调试 |
| `npm start` | ❌ 需手动重启 | 快 | 测试/演示 |

---

### 2.2 验证服务器启动成功

**预期Console输出**：
```
============================================================
🎮 Cute Pet Escape - Multiplayer Server
============================================================
✅ Server is running on http://localhost:2567
✅ WebSocket endpoint: ws://localhost:2567
============================================================
📋 Available endpoints:
   GET  http://localhost:2567/         - Health check
   GET  http://localhost:2567/rooms    - List all rooms
============================================================
🚀 Server is ready to accept connections!
============================================================
```

**如果看到此输出**：✅ 服务器启动成功！

---

### 2.3 测试服务器连接

**打开浏览器**，访问以下URL：

#### 测试1：健康检查
```
http://localhost:2567/
```

**预期响应**：
```json
{
  "status": "ok",
  "message": "Cute Pet Escape Server is running!",
  "version": "1.0.0",
  "rooms": 0
}
```

#### 测试2：查看房间列表
```
http://localhost:2567/rooms
```

**预期响应**（初始状态）：
```json
{
  "success": true,
  "rooms": []
}
```

**如果两个测试都成功**：✅ 服务器工作正常！

---

### 2.4 配置防火墙（如有必要）

**macOS**：
1. 系统偏好设置 → 安全性与隐私 → 防火墙
2. 如果提示"是否允许Node.js接受传入连接"，点击**允许**

**Windows**：
1. Windows Defender防火墙可能会弹窗
2. 勾选"专用网络"和"公用网络"
3. 点击**允许访问**

---

## 3. 云服务器部署（可选）

### 3.1 使用Render.com（免费）

#### 步骤1：注册Render账号
1. 访问 https://render.com
2. 使用GitHub账号登录（推荐）

#### 步骤2：推送代码到GitHub
```bash
# 在项目根目录
cd /Users/clare/Desktop/前哨AI小课/ClareProject/Cute-Pet-Escape-Project

# 初始化Git（如果还没有）
git init
git add server/
git commit -m "Add Colyseus server"

# 推送到GitHub
git remote add origin <你的GitHub仓库地址>
git push -u origin main
```

#### 步骤3：在Render创建Web Service
1. 登录Render → Dashboard → "New +"
2. 选择"Web Service"
3. 连接GitHub仓库
4. 配置：
   - **Name**: `cute-pet-escape-server`
   - **Root Directory**: `server`
   - **Build Command**: `npm install && npm run build`
   - **Start Command**: `npm start`
   - **Instance Type**: Free

5. 点击"Create Web Service"
6. 等待部署（3-5分钟）

#### 步骤4：获取服务器地址
部署成功后，Render会提供一个URL，例如：
```
https://cute-pet-escape-server.onrender.com
```

#### 步骤5：修改客户端服务器地址
在Cocos Creator中，修改NetworkManager的`serverUrl`：
```typescript
// 从
public serverUrl: string = "ws://localhost:2567";

// 改为（注意ws改为wss）
public serverUrl: string = "wss://cute-pet-escape-server.onrender.com";
```

---

### 3.2 使用Railway.app（免费）

#### 步骤1：注册Railway账号
1. 访问 https://railway.app
2. 使用GitHub账号登录

#### 步骤2：部署
1. Dashboard → "New Project"
2. 选择"Deploy from GitHub repo"
3. 选择你的仓库
4. Railway会自动检测Node.js项目
5. 设置环境变量（如需要）：
   - `PORT`: 2567

#### 步骤3：获取域名
1. 点击你的服务 → Settings → Domains
2. 点击"Generate Domain"
3. 获得类似 `your-app.up.railway.app` 的域名

#### 步骤4：修改客户端
```typescript
public serverUrl: string = "wss://your-app.up.railway.app";
```

---

### 3.3 本地服务器外网访问（使用ngrok）

**如果你想让朋友在外网测试，但不想部署到云服务器**：

#### 步骤1：安装ngrok
```bash
# macOS (使用Homebrew)
brew install ngrok

# 或访问 https://ngrok.com 下载
```

#### 步骤2：启动本地服务器
```bash
cd server
npm run dev
```

#### 步骤3：使用ngrok创建隧道
**新开一个终端**：
```bash
ngrok http 2567
```

#### 步骤4：获取公网地址
ngrok会显示：
```
Forwarding   https://abc123.ngrok.io -> http://localhost:2567
```

#### 步骤5：修改客户端
```typescript
public serverUrl: string = "wss://abc123.ngrok.io";
```

**注意**：
- ✅ 免费版ngrok的地址每次启动都会变化
- ✅ 适合临时测试
- ❌ 不适合长期使用

---

## 4. 常见问题排查

### 问题1：`npm install`失败

**错误信息**：
```
npm ERR! code EACCES
npm ERR! syscall access
```

**解决方案**：
```bash
# macOS/Linux
sudo npm install

# 或更改npm全局目录权限
mkdir ~/.npm-global
npm config set prefix '~/.npm-global'
export PATH=~/.npm-global/bin:$PATH
```

---

### 问题2：端口2567被占用

**错误信息**：
```
Error: listen EADDRINUSE: address already in use :::2567
```

**解决方案1：查找并杀死占用进程**
```bash
# macOS/Linux
lsof -i :2567
kill -9 <PID>

# Windows
netstat -ano | findstr :2567
taskkill /PID <PID> /F
```

**解决方案2：更改端口**
```bash
# 启动时指定端口
PORT=3000 npm start

# 然后修改客户端连接地址为 ws://localhost:3000
```

---

### 问题3：客户端连接失败

**检查清单**：
1. ✅ 服务器是否正在运行？
   ```bash
   # 访问 http://localhost:2567/ 是否有响应
   ```

2. ✅ 服务器地址是否正确？
   ```typescript
   // 本地：ws://localhost:2567
   // 云端：wss://your-domain.com
   ```

3. ✅ 是否使用了正确的协议？
   ```
   本地HTTP → ws://
   云端HTTPS → wss://
   ```

4. ✅ 防火墙是否允许？
   - 检查系统防火墙设置
   - 检查杀毒软件是否拦截

---

### 问题4：CORS跨域错误

**错误信息（浏览器Console）**：
```
Access to XMLHttpRequest has been blocked by CORS policy
```

**解决方案**：
服务器代码已包含CORS配置：
```typescript
// server/src/index.ts
app.use(cors());  // ✅ 已配置
```

如果仍有问题，修改为：
```typescript
app.use(cors({
    origin: '*',  // 允许所有域名（开发环境）
    credentials: true
}));
```

---

### 问题5：TypeScript编译错误

**错误信息**：
```
error TS2307: Cannot find module '@colyseus/core'
```

**解决方案**：
```bash
# 删除node_modules和锁文件
rm -rf node_modules package-lock.json

# 重新安装
npm install

# 如果还是不行，尝试安装特定版本
npm install @colyseus/core@0.15.0 --save
```

---

### 问题6：客户端Colyseus库未安装

**错误信息（Cocos Creator Console）**：
```
Cannot find module 'colyseus.js'
```

**解决方案**：
参见`任务4.1_客户端配置指南.md`的第2章节。

---

## 5. 性能优化建议

### 5.1 同步频率优化

**默认设置**：
```typescript
// PlayerSyncController.ts
public syncInterval: number = 0.05; // 20次/秒
```

**根据网络情况调整**：
| 网络质量 | 推荐频率 | syncInterval值 |
|---------|---------|---------------|
| 优秀（<50ms） | 30次/秒 | 0.033 |
| 良好（50-100ms） | 20次/秒 | 0.05 |
| 一般（100-200ms） | 15次/秒 | 0.067 |
| 较差（>200ms） | 10次/秒 | 0.1 |

---

### 5.2 服务器性能监控

**查看服务器日志**：
```bash
# 如果使用pm2管理进程
pm2 logs

# 如果直接运行
# 查看Console输出
```

**监控指标**：
- 房间数量
- 玩家数量
- 消息频率
- 内存使用

---

## 6. 生产环境建议

### 6.1 使用进程管理器（PM2）

**安装PM2**：
```bash
npm install -g pm2
```

**启动服务器**：
```bash
cd server
pm2 start lib/index.js --name "cute-pet-escape"
```

**常用命令**：
```bash
pm2 list          # 查看所有进程
pm2 logs          # 查看日志
pm2 restart all   # 重启
pm2 stop all      # 停止
pm2 delete all    # 删除
```

---

### 6.2 配置环境变量

**创建`.env`文件**：
```bash
# server/.env
PORT=2567
NODE_ENV=production
```

**修改代码读取**：
```typescript
// server/src/index.ts
import dotenv from 'dotenv';
dotenv.config();

const PORT = process.env.PORT || 2567;
```

---

## 7. 下一步

服务器部署完成后：
1. ✅ 验证服务器访问正常
2. ✅ 配置客户端连接地址
3. ✅ 参见`任务4.1_客户端配置指南.md`完成Cocos Creator配置
4. ✅ 参见`任务4.1_联机测试指南.md`进行双人测试

---

**文档生成时间**：2025-10-02
**适用版本**：Node.js 18.x+, Colyseus 0.15.x
**部署状态**：✅ 本地开发就绪
