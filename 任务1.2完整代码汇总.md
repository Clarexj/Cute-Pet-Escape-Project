# ä»»åŠ¡1.2 å®Œæ•´ä»£ç æ±‡æ€»

## ðŸ“‹ ä»»åŠ¡ä¿¡æ¯

**ä»»åŠ¡åç§°ï¼š** å®žçŽ°å¯æ‹–æ‹½çš„é•œå¤´è½¬åŠ¨
**å¼€å‘æ—¶é—´ï¼š** 2025-10-01
**å¼€å‘è€…ï¼š** Claude Code

---

## ðŸ“ æ¶‰åŠçš„æ–‡ä»¶

| æ–‡ä»¶å | çŠ¶æ€ | è¯´æ˜Ž |
|--------|------|------|
| `CameraFollow.ts` | å·²ä¿®æ”¹ | æ·»åŠ æ°´å¹³æ—‹è½¬æ”¯æŒ |
| `CameraController.ts` | æ–°åˆ›å»º | å¤„ç†è§¦æ‘¸è¾“å…¥æŽ§åˆ¶é•œå¤´æ—‹è½¬ |
| `PlayerController.ts` | æ— éœ€ä¿®æ”¹ | å·²æ”¯æŒç›¸å¯¹æ‘„åƒæœºç§»åŠ¨ |

---

## ðŸŽ¯ åŠŸèƒ½å®žçŽ°è¯´æ˜Ž

### æ ¸å¿ƒåŠŸèƒ½
1. âœ… åœ¨å±å¹•éžæ‘‡æ†åŒºåŸŸæ‹–åŠ¨å¯æ—‹è½¬æ‘„åƒæœº
2. âœ… æ‘„åƒæœºæ°´å¹³å›´ç»•è§’è‰²æ—‹è½¬
3. âœ… æ—‹è½¬å¹³æ»‘ï¼Œæ— æŠ–åŠ¨
4. âœ… æ‘‡æ†ç§»åŠ¨å§‹ç»ˆç›¸å¯¹äºŽå½“å‰æ‘„åƒæœºæ–¹å‘
5. âœ… å·¦ä¾§æ‘‡æ†åŒºåŸŸä¸å“åº”é•œå¤´æ—‹è½¬

### æŠ€æœ¯ç‰¹ç‚¹
- èŒè´£åˆ†ç¦»æ¸…æ™°ï¼ˆè¾“å…¥ã€è·Ÿéšã€ç§»åŠ¨åˆ†åˆ«ç”±ä¸åŒç»„ä»¶å¤„ç†ï¼‰
- æ€§èƒ½ä¼˜åŒ–ï¼ˆå¤ç”¨ä¸´æ—¶å˜é‡ï¼Œé¿å…é¢‘ç¹åˆ›å»ºå¯¹è±¡ï¼‰
- å¯é…ç½®å‚æ•°ï¼ˆçµæ•åº¦ã€æŽ’é™¤åŒºåŸŸç­‰å¯è°ƒæ•´ï¼‰
- ä¸ºåŽç»­ä»»åŠ¡é¢„ç•™æ‰©å±•æ€§

---

## ðŸ“„ å®Œæ•´ä»£ç 

### æ–‡ä»¶1ï¼šCameraFollow.tsï¼ˆå·²ä¿®æ”¹ï¼‰

**æ–‡ä»¶ä½ç½®ï¼š** `assets/scripts/CameraFollow.ts`

```typescript
// æ–‡ä»¶å: CameraFollow.ts
// åŠŸèƒ½ï¼šç¬¬ä¸‰äººç§°æ‘„åƒæœºè·Ÿéšç³»ç»Ÿï¼Œæ”¯æŒæ°´å¹³æ—‹è½¬ï¼ˆä»»åŠ¡1.2ï¼‰

import { _decorator, Component, Node, Vec3, Quat } from 'cc';
const { ccclass, property } = _decorator;

@ccclass('CameraFollow')
export class CameraFollow extends Component {
    @property(Node)
    public target: Node = null!; // è·Ÿéšç›®æ ‡ï¼ˆçŽ©å®¶è§’è‰²ï¼‰

    @property
    public followDistance: number = 8.0; // æ‘„åƒæœºè·ç¦»è§’è‰²çš„è·ç¦»

    @property
    public followHeight: number = 5.0; // æ‘„åƒæœºé«˜åº¦åç§»

    @property
    public lookAtHeight: number = 1.0; // æ‘„åƒæœºçœ‹å‘ç›®æ ‡çš„é«˜åº¦åç§»

    @property
    public smoothSpeed: number = 5.0; // è·Ÿéšå¹³æ»‘é€Ÿåº¦

    @property
    public pitchAngle: number = 30.0; // ä¿¯ä»°è§’åº¦ï¼ˆå‘ä¸‹çœ‹çš„è§’åº¦ï¼‰

    @property
    public rotationSmoothSpeed: number = 10.0; // æ—‹è½¬å¹³æ»‘é€Ÿåº¦

    private _currentOffset: Vec3 = new Vec3(); // å½“å‰åç§»é‡
    private _targetOffset: Vec3 = new Vec3(); // ç›®æ ‡åç§»é‡
    private _lookAtPoint: Vec3 = new Vec3(); // çœ‹å‘ç‚¹

    // ä»»åŠ¡1.2æ–°å¢žï¼šæ°´å¹³æ—‹è½¬è§’åº¦ï¼ˆyaw angleï¼‰
    private _yawAngle: number = 0; // å½“å‰æ°´å¹³æ—‹è½¬è§’åº¦
    private _targetYawAngle: number = 0; // ç›®æ ‡æ°´å¹³æ—‹è½¬è§’åº¦

    // æ€§èƒ½ä¼˜åŒ–ï¼šå¤ç”¨ä¸´æ—¶å˜é‡
    private _tempVec3: Vec3 = new Vec3();
    private _tempQuat: Quat = new Quat();

    start() {
        // åˆå§‹åŒ–æ‘„åƒæœºåç§»
        this.calculateTargetOffset();
        this._currentOffset.set(this._targetOffset);
        this.updateCameraPosition(0);
    }

    lateUpdate(deltaTime: number) {
        if (!this.target) return;

        // å¹³æ»‘æ’å€¼æ°´å¹³æ—‹è½¬è§’åº¦
        const angleDiff = this._targetYawAngle - this._yawAngle;
        this._yawAngle += angleDiff * this.rotationSmoothSpeed * deltaTime;

        // è®¡ç®—ç›®æ ‡åç§»
        this.calculateTargetOffset();

        // å¹³æ»‘æ’å€¼åˆ°ç›®æ ‡åç§»
        Vec3.lerp(this._currentOffset, this._currentOffset, this._targetOffset, this.smoothSpeed * deltaTime);

        // æ›´æ–°æ‘„åƒæœºä½ç½®å’Œæœå‘
        this.updateCameraPosition(deltaTime);
    }

    /**
     * è®¡ç®—æ‘„åƒæœºç›¸å¯¹è§’è‰²çš„ç›®æ ‡åç§»ï¼ˆæ”¯æŒæ°´å¹³æ—‹è½¬ï¼‰
     */
    private calculateTargetOffset() {
        // ä¿¯ä»°è§’è½¬å¼§åº¦
        const pitchRad = this.pitchAngle * (Math.PI / 180);

        // æ°´å¹³è§’è½¬å¼§åº¦
        const yawRad = this._yawAngle * (Math.PI / 180);

        // è®¡ç®—æ°´å¹³è·ç¦»å’Œåž‚ç›´è·ç¦»
        const horizontalDist = this.followDistance * Math.cos(pitchRad);
        const verticalDist = this.followDistance * Math.sin(pitchRad) + this.followHeight;

        // æ ¹æ®æ°´å¹³æ—‹è½¬è§’åº¦è®¡ç®—åç§»ï¼ˆå›´ç»•è§’è‰²æ—‹è½¬ï¼‰
        const offsetX = horizontalDist * Math.sin(yawRad);
        const offsetZ = -horizontalDist * Math.cos(yawRad);

        this._targetOffset.set(offsetX, verticalDist, offsetZ);
    }

    /**
     * æ›´æ–°æ‘„åƒæœºä½ç½®å’Œæœå‘
     */
    private updateCameraPosition(deltaTime: number) {
        // æ‘„åƒæœºä½ç½® = è§’è‰²ä½ç½® + åç§»
        this.target.getWorldPosition(this._tempVec3);
        Vec3.add(this._tempVec3, this._tempVec3, this._currentOffset);
        this.node.setWorldPosition(this._tempVec3);

        // æ‘„åƒæœºçœ‹å‘è§’è‰²ï¼ˆåŠ ä¸Šé«˜åº¦åç§»ï¼‰
        const targetPos = this.target.getWorldPosition();
        this._lookAtPoint.set(
            targetPos.x,
            targetPos.y + this.lookAtHeight,
            targetPos.z
        );

        // è®¡ç®—æœå‘
        Vec3.subtract(this._tempVec3, this._lookAtPoint, this.node.worldPosition);
        this._tempVec3.normalize();
        Quat.fromViewUp(this._tempQuat, this._tempVec3);
        this.node.setWorldRotation(this._tempQuat);
    }

    /**
     * è®¾ç½®æ°´å¹³æ—‹è½¬è§’åº¦ï¼ˆä»»åŠ¡1.2æ–°å¢žï¼‰
     * @param angle æ°´å¹³æ—‹è½¬è§’åº¦ï¼ˆåº¦ï¼‰
     */
    public setYawAngle(angle: number) {
        this._targetYawAngle = angle;
    }

    /**
     * å¢žåŠ æ°´å¹³æ—‹è½¬è§’åº¦ï¼ˆä»»åŠ¡1.2æ–°å¢žï¼‰
     * @param delta è§’åº¦å¢žé‡ï¼ˆåº¦ï¼‰
     */
    public addYawAngle(delta: number) {
        this._targetYawAngle += delta;
        // è§„èŒƒåŒ–åˆ°-180åˆ°180åº¦
        while (this._targetYawAngle > 180) this._targetYawAngle -= 360;
        while (this._targetYawAngle < -180) this._targetYawAngle += 360;
    }

    /**
     * èŽ·å–å½“å‰æ°´å¹³æ—‹è½¬è§’åº¦
     */
    public getYawAngle(): number {
        return this._yawAngle;
    }

    /**
     * è®¾ç½®ä¿¯ä»°è§’
     */
    public setPitchAngle(angle: number) {
        this.pitchAngle = Math.max(-85, Math.min(85, angle)); // é™åˆ¶åœ¨-85åˆ°85åº¦
    }

    /**
     * è®¾ç½®è·Ÿéšè·ç¦»
     */
    public setFollowDistance(distance: number) {
        this.followDistance = Math.max(3.0, Math.min(15.0, distance)); // é™åˆ¶è·ç¦»
    }
}
```

---

### æ–‡ä»¶2ï¼šCameraController.tsï¼ˆæ–°åˆ›å»ºï¼‰

**æ–‡ä»¶ä½ç½®ï¼š** `assets/scripts/CameraController.ts`

```typescript
// æ–‡ä»¶å: CameraController.ts
// åŠŸèƒ½ï¼šå¤„ç†å±å¹•å³ä¾§è§¦æ‘¸æ‹–æ‹½æ¥æ—‹è½¬æ‘„åƒæœºï¼ˆä»»åŠ¡1.2ï¼‰

import { _decorator, Component, Node, EventTouch, Vec2, UITransform, Canvas } from 'cc';
import { CameraFollow } from './CameraFollow';
const { ccclass, property } = _decorator;

@ccclass('CameraController')
export class CameraController extends Component {
    @property(CameraFollow)
    public cameraFollow: CameraFollow = null!; // CameraFollowç»„ä»¶å¼•ç”¨

    @property(Node)
    public joystickArea: Node = null!; // æ‘‡æ†åŒºåŸŸèŠ‚ç‚¹ï¼ˆç”¨äºŽåˆ¤æ–­æ˜¯å¦åœ¨æ‘‡æ†åŒºåŸŸå†…ï¼‰

    @property
    public rotationSensitivity: number = 0.2; // æ—‹è½¬çµæ•åº¦

    @property
    public joystickExclusionRadius: number = 250; // æ‘‡æ†æŽ’é™¤åŠå¾„ï¼ˆå±å¹•å·¦ä¾§å¤šå¤§èŒƒå›´ä¸å“åº”ï¼‰

    private _touchId: number = -1; // å½“å‰è§¦æ‘¸ID
    private _lastTouchPos: Vec2 = new Vec2(); // ä¸Šä¸€æ¬¡è§¦æ‘¸ä½ç½®
    private _isDragging: boolean = false; // æ˜¯å¦æ­£åœ¨æ‹–æ‹½

    // æ€§èƒ½ä¼˜åŒ–ï¼šå¤ç”¨ä¸´æ—¶å˜é‡
    private _tempVec2: Vec2 = new Vec2();

    onLoad() {
        // ç›‘å¬Canvasä¸Šçš„è§¦æ‘¸äº‹ä»¶ï¼ˆå…¨å±ç›‘å¬ï¼‰
        const canvas = this.node.getComponent(Canvas);
        if (canvas) {
            this.node.on(Node.EventType.TOUCH_START, this.onTouchStart, this);
            this.node.on(Node.EventType.TOUCH_MOVE, this.onTouchMove, this);
            this.node.on(Node.EventType.TOUCH_END, this.onTouchEnd, this);
            this.node.on(Node.EventType.TOUCH_CANCEL, this.onTouchEnd, this);
        } else {
            console.warn('[CameraController] è¯·å°†æ­¤ç»„ä»¶æŒ‚åœ¨CanvasèŠ‚ç‚¹ä¸Šï¼');
        }
    }

    onDestroy() {
        this.node.off(Node.EventType.TOUCH_START, this.onTouchStart, this);
        this.node.off(Node.EventType.TOUCH_MOVE, this.onTouchMove, this);
        this.node.off(Node.EventType.TOUCH_END, this.onTouchEnd, this);
        this.node.off(Node.EventType.TOUCH_CANCEL, this.onTouchEnd, this);
    }

    private onTouchStart(event: EventTouch) {
        const uiPos = event.getUILocation();

        // æ£€æŸ¥æ˜¯å¦åœ¨æ‘‡æ†åŒºåŸŸï¼ˆå·¦ä¾§åŒºåŸŸï¼‰
        if (this.isInJoystickArea(uiPos)) {
            return; // åœ¨æ‘‡æ†åŒºåŸŸï¼Œä¸å¤„ç†
        }

        // è®°å½•è§¦æ‘¸ä¿¡æ¯
        this._touchId = event.touch!.getID();
        this._lastTouchPos.set(uiPos.x, uiPos.y);
        this._isDragging = true;
    }

    private onTouchMove(event: EventTouch) {
        // åªå¤„ç†å½“å‰è§¦æ‘¸
        if (event.touch!.getID() !== this._touchId || !this._isDragging) return;

        const uiPos = event.getUILocation();

        // è®¡ç®—æ‹–æ‹½åç§»é‡
        this._tempVec2.set(
            uiPos.x - this._lastTouchPos.x,
            uiPos.y - this._lastTouchPos.y
        );

        // æ°´å¹³æ‹–æ‹½æŽ§åˆ¶æ‘„åƒæœºæ°´å¹³æ—‹è½¬
        const deltaYaw = this._tempVec2.x * this.rotationSensitivity;

        if (this.cameraFollow) {
            this.cameraFollow.addYawAngle(deltaYaw);
        }

        // æ›´æ–°ä¸Šä¸€æ¬¡è§¦æ‘¸ä½ç½®
        this._lastTouchPos.set(uiPos.x, uiPos.y);
    }

    private onTouchEnd(event: EventTouch) {
        // åªå¤„ç†å½“å‰è§¦æ‘¸
        if (event.touch!.getID() !== this._touchId) return;

        // é‡ç½®çŠ¶æ€
        this._touchId = -1;
        this._isDragging = false;
    }

    /**
     * åˆ¤æ–­è§¦æ‘¸ä½ç½®æ˜¯å¦åœ¨æ‘‡æ†åŒºåŸŸå†…
     * @param uiPos UIåæ ‡ç³»çš„è§¦æ‘¸ä½ç½®
     */
    private isInJoystickArea(uiPos: Vec2): boolean {
        // èŽ·å–Canvasçš„UITransform
        const uiTransform = this.node.getComponent(UITransform);
        if (!uiTransform) return false;

        // å°†UIåæ ‡è½¬æ¢ä¸ºä»¥Canvasä¸­å¿ƒä¸ºåŽŸç‚¹çš„åæ ‡
        const canvasWidth = uiTransform.width;
        const canvasHeight = uiTransform.height;

        // UIåæ ‡åŽŸç‚¹åœ¨å·¦ä¸‹è§’ï¼Œè½¬æ¢ä¸ºä»¥ä¸­å¿ƒä¸ºåŽŸç‚¹çš„åæ ‡
        const centerX = uiPos.x - canvasWidth / 2;
        const centerY = uiPos.y - canvasHeight / 2;

        // å¦‚æžœåœ¨å±å¹•å·¦ä¾§æŒ‡å®šèŒƒå›´å†…ï¼Œè®¤ä¸ºæ˜¯æ‘‡æ†åŒºåŸŸ
        if (centerX < -canvasWidth / 2 + this.joystickExclusionRadius) {
            return true;
        }

        // å¦‚æžœjoystickAreaèŠ‚ç‚¹å­˜åœ¨ï¼Œä¹Ÿå¯ä»¥ç”¨å®ƒçš„ä½ç½®åˆ¤æ–­
        if (this.joystickArea) {
            const joystickUITransform = this.joystickArea.getComponent(UITransform);
            if (joystickUITransform) {
                const joystickWorldPos = this.joystickArea.worldPosition;
                const distance = Math.sqrt(
                    Math.pow(centerX - joystickWorldPos.x, 2) +
                    Math.pow(centerY - joystickWorldPos.y, 2)
                );
                if (distance < this.joystickExclusionRadius) {
                    return true;
                }
            }
        }

        return false;
    }

    /**
     * è®¾ç½®æ—‹è½¬çµæ•åº¦
     */
    public setRotationSensitivity(sensitivity: number) {
        this.rotationSensitivity = Math.max(0.05, Math.min(1.0, sensitivity));
    }

    /**
     * æ˜¯å¦æ­£åœ¨æ‹–æ‹½æ—‹è½¬æ‘„åƒæœº
     */
    public isDragging(): boolean {
        return this._isDragging;
    }
}
```

---

## ðŸŽ® Cocos Creator é…ç½®å¿«é€Ÿå‚è€ƒ

### 1. ç»™Canvasæ·»åŠ CameraControllerç»„ä»¶
- é€‰ä¸­ `Canvas` èŠ‚ç‚¹
- æ·»åŠ ç»„ä»¶ â†’ è‡ªå®šä¹‰ç»„ä»¶ â†’ `CameraController`

### 2. é…ç½®CameraControllerå±žæ€§
- **Camera Follow**: æ‹–å…¥ `Main Camera` èŠ‚ç‚¹
- **Joystick Area**: æ‹–å…¥ `JoystickBase` èŠ‚ç‚¹
- **Rotation Sensitivity**: `0.2`ï¼ˆå¯è°ƒæ•´ï¼‰
- **Joystick Exclusion Radius**: `250`

### 3. ç¡®è®¤Main Cameraçš„CameraFollowé…ç½®
- **Target**: `Player` èŠ‚ç‚¹
- **Rotation Smooth Speed**: `10`ï¼ˆæ–°å¢žå‚æ•°ï¼‰
- å…¶ä»–å‚æ•°ä¿æŒä¸å˜

### 4. PlayerControlleræ— éœ€ä¿®æ”¹
- ä¿æŒçŽ°æœ‰é…ç½®å³å¯

---

## âœ… éªŒæ”¶æµ‹è¯•æ¸…å•

- [ ] æ‹–åŠ¨å±å¹•å³ä¾§ï¼Œæ‘„åƒæœºæ°´å¹³æ—‹è½¬
- [ ] æ—‹è½¬å¹³æ»‘ï¼Œæ— æŠ–åŠ¨æˆ–è·³å˜
- [ ] å·¦ä¾§æ‘‡æ†åŒºåŸŸä¸å“åº”é•œå¤´æ—‹è½¬
- [ ] æ—‹è½¬åŽï¼Œæ‘‡æ†"å‘ä¸Š"å§‹ç»ˆè®©è§’è‰²å‘å±å¹•å‰æ–¹ç§»åŠ¨
- [ ] æ—‹è½¬åŽï¼Œæ‘‡æ†"å‘å·¦"å§‹ç»ˆè®©è§’è‰²å‘å±å¹•å·¦æ–¹ç§»åŠ¨
- [ ] å¯ä»¥è¾¹ç§»åŠ¨è¾¹æ—‹è½¬é•œå¤´

---

## ðŸ”§ å¸¸ç”¨è°ƒè¯•å‚æ•°

| å‚æ•° | ä½ç½® | å»ºè®®èŒƒå›´ | è¯´æ˜Ž |
|------|------|----------|------|
| Rotation Sensitivity | CameraController | 0.1-0.5 | æ—‹è½¬çµæ•åº¦ |
| Joystick Exclusion Radius | CameraController | 200-350 | æ‘‡æ†æŽ’é™¤åŠå¾„ |
| Rotation Smooth Speed | CameraFollow | 5-15 | æ—‹è½¬å¹³æ»‘åº¦ |

---

## ðŸ“Š ä»£ç å˜æ›´ç»Ÿè®¡

- **ä¿®æ”¹æ–‡ä»¶**: 1ä¸ªï¼ˆCameraFollow.tsï¼‰
- **æ–°å¢žæ–‡ä»¶**: 1ä¸ªï¼ˆCameraController.tsï¼‰
- **æ–°å¢žä»£ç è¡Œæ•°**: çº¦200è¡Œ
- **æ€§èƒ½ä¼˜åŒ–**: å¤ç”¨ä¸´æ—¶å˜é‡ï¼Œé¿å…GCåŽ‹åŠ›

---

## ðŸš€ åŽç»­ä»»åŠ¡é¢„å‘Š

**ä»»åŠ¡1.3ï¼šå®žçŽ°"æŽ¨å€’æœ¨æ¿"ä¸Ž"æ‹¾å–çŸ¿çŸ³"çš„æ ¸å¿ƒäº¤äº’åŽŸåž‹**

å°†ä¼šæ¶‰åŠï¼š
- å°„çº¿æ£€æµ‹ï¼ˆRay Castingï¼‰
- äº¤äº’UIæç¤º
- ç‰©ä½“çŠ¶æ€ç®¡ç†
- äº¤äº’æŒ‰é’®

å½“å‰çš„æ‘„åƒæœºå’Œç§»åŠ¨ç³»ç»Ÿä¸ºè¿™äº›äº¤äº’æä¾›äº†è‰¯å¥½åŸºç¡€ï¼

---

**ä»»åŠ¡1.2å®Œæˆï¼** ðŸŽ‰
